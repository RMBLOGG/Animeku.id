{% extends "base.html" %}
{% block title %}Premium — Animeku.id{% endblock %}

{% block head %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&display=swap');

.premium-page {
  min-height: 100vh;
  padding-bottom: 80px;
  position: relative;
  overflow: hidden;
}
.premium-page::before {
  content: '';
  position: fixed;
  top: -150px; left: 50%;
  transform: translateX(-50%);
  width: 600px; height: 600px;
  background: radial-gradient(circle, rgba(244,162,97,0.10) 0%, transparent 70%);
  pointer-events: none;
  z-index: 0;
}

/* ── HERO ── */
.prem-hero {
  text-align: center;
  padding: 56px 20px 36px;
  position: relative;
  z-index: 1;
}
.prem-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 18px;
  background: linear-gradient(135deg, rgba(244,162,97,0.2), rgba(231,111,27,0.2));
  border: 1px solid rgba(244,162,97,0.4);
  border-radius: 99px;
  font-size: 11px;
  font-weight: 700;
  color: #f4a261;
  letter-spacing: 2px;
  text-transform: uppercase;
  margin-bottom: 20px;
}
.prem-title {
  font-family: 'Cinzel', serif;
  font-size: clamp(26px, 6vw, 44px);
  font-weight: 900;
  color: var(--text);
  letter-spacing: 1px;
  line-height: 1.2;
  margin-bottom: 14px;
}
.prem-title span {
  background: linear-gradient(135deg, #f4a261, #e76f1b);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}
.prem-sub {
  color: var(--text2);
  font-size: 14px;
  max-width: 400px;
  margin: 0 auto;
  line-height: 1.7;
}

/* ── PRICE CARD ── */
.prem-card-wrap {
  display: flex;
  justify-content: center;
  padding: 0 16px 40px;
  position: relative;
  z-index: 1;
}
.prem-card {
  background: var(--card);
  border: 1px solid rgba(244,162,97,0.25);
  border-radius: 20px;
  padding: 32px;
  max-width: 400px;
  width: 100%;
  box-shadow: 0 8px 40px rgba(0,0,0,0.35);
  position: relative;
  overflow: hidden;
}
.prem-card::after {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 2px;
  background: linear-gradient(90deg, transparent 0%, #f4a261 40%, #ffd166 60%, transparent 100%);
}

.prem-price-row {
  display: flex;
  align-items: baseline;
  gap: 4px;
  margin-bottom: 4px;
}
.prem-price-amt {
  font-family: 'Cinzel', serif;
  font-size: 44px;
  font-weight: 900;
  color: var(--text);
  line-height: 1;
}
.prem-price-period { font-size: 13px; color: var(--text3); }
.prem-price-note { font-size: 11px; color: var(--text3); margin-bottom: 20px; }

.prem-features {
  list-style: none;
  padding: 0; margin: 0 0 24px;
  display: flex; flex-direction: column; gap: 10px;
}
.prem-features li {
  display: flex; align-items: center; gap: 10px;
  font-size: 13px; color: var(--text2);
}
.feat-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: #f4a261; flex-shrink: 0;
}

.prem-divider { border: none; border-top: 1px solid var(--border); margin: 0 0 20px; }

/* User section */
#premUserSection {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Skeleton loader */
.skel {
  border-radius: 8px;
  background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 75%);
  background-size: 200% 100%;
  animation: skel 1.5s infinite;
}
@keyframes skel { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* UID Box */
.uid-box {
  background: rgba(255,255,255,0.04);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 14px;
}
.uid-label {
  font-size: 10px; font-weight: 700; color: var(--text3);
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px;
}
.uid-row { display: flex; align-items: center; gap: 8px; }
.uid-val {
  font-family: var(--font-mono, monospace); font-size: 11px;
  color: var(--text2); flex: 1;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.uid-copy {
  flex-shrink: 0; padding: 4px 10px;
  background: rgba(244,162,97,0.1); border: 1px solid rgba(244,162,97,0.3);
  border-radius: 6px; color: #f4a261; font-size: 11px; font-weight: 600;
  cursor: pointer; white-space: nowrap; transition: background 0.2s;
}
.uid-copy:hover { background: rgba(244,162,97,0.2); }
.uid-hint { font-size: 11px; color: var(--text3); line-height: 1.5; margin-top: 6px; }

/* Buttons */
.btn-pay {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 15px; background: linear-gradient(135deg, #f4a261, #e76f1b);
  color: #000; font-weight: 700; font-size: 14px; border-radius: 12px;
  text-decoration: none; cursor: pointer; border: none; width: 100%;
  box-shadow: 0 4px 20px rgba(244,162,97,0.3);
  transition: transform 0.15s, box-shadow 0.15s;
}
.btn-pay:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(244,162,97,0.4); }
.btn-login-g {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  padding: 13px; background: rgba(255,255,255,0.06);
  border: 1px solid var(--border); border-radius: 12px;
  color: var(--text); font-size: 14px; font-weight: 600;
  text-decoration: none; transition: background 0.2s;
}
.btn-login-g:hover { background: rgba(255,255,255,0.1); }
.btn-pay-note { text-align: center; font-size: 11px; color: var(--text3); }

/* Active banner */
.prem-active {
  background: rgba(76,175,125,0.1); border: 1px solid rgba(76,175,125,0.3);
  border-radius: 12px; padding: 20px; text-align: center;
}
.prem-active .icon { font-size: 30px; margin-bottom: 6px; }
.prem-active h3 { color: #4caf7d; font-size: 16px; margin: 0 0 4px; }
.prem-active p { color: var(--text2); font-size: 12px; margin: 0; }

/* ── HOW IT WORKS ── */
.how-section {
  max-width: 400px; margin: 0 auto;
  padding: 0 16px; position: relative; z-index: 1;
}
.how-title {
  text-align: center; font-size: 11px; font-weight: 700;
  color: var(--text3); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px;
}
.steps { display: flex; flex-direction: column; }
.step {
  display: flex; gap: 14px; align-items: flex-start;
  position: relative; padding-bottom: 20px;
}
.step:last-child { padding-bottom: 0; }
.step:not(:last-child)::after {
  content: ''; position: absolute; left: 13px; top: 28px; bottom: 0;
  width: 2px; background: linear-gradient(to bottom, rgba(244,162,97,0.25), transparent);
}
.step-num {
  width: 28px; height: 28px; border-radius: 50%;
  background: rgba(244,162,97,0.12); border: 1px solid rgba(244,162,97,0.25);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 700; color: #f4a261; flex-shrink: 0;
}
.step-text strong { display: block; font-size: 13px; color: var(--text); margin-bottom: 2px; }
.step-text span { font-size: 12px; color: var(--text3); line-height: 1.5; }
</style>
{% endblock %}

{% block content %}
<div class="premium-page">

  <!-- HERO — statis, langsung tampil -->
  <div class="prem-hero">
    <div class="prem-badge">✦ &nbsp;Animeku Premium</div>
    <h1 class="prem-title">Nonton Tanpa Batas,<br><span>Tanpa Iklan</span></h1>
    <p class="prem-sub">Akses semua episode anime favorit kamu — tanpa batasan, tanpa gangguan.</p>
  </div>

  <!-- PRICE CARD — statis, langsung tampil -->
  <div class="prem-card-wrap">
    <div class="prem-card">

      <div class="prem-price-row">
        <span class="prem-price-amt">15K</span>
        <span class="prem-price-period">/ bulan</span>
      </div>
      <p class="prem-price-note">Rp 15.000 — Transfer Bank, QRIS, E-Wallet</p>

      <ul class="prem-features">
        <li><span class="feat-dot"></span> Semua episode tanpa kunci (ep 3 ke atas)</li>
        <li><span class="feat-dot"></span> Akses penuh selama 30 hari</li>
        <li><span class="feat-dot"></span> Aktif otomatis setelah bayar</li>
        <li><span class="feat-dot"></span> Dukung operasional Animeku.id</li>
      </ul>

      <hr class="prem-divider">

      <!-- Bagian dinamis: skeleton dulu, lalu diisi JS -->
      <div id="premUserSection">
        <div class="skel" style="height:12px;width:55%;margin-bottom:10px"></div>
        <div class="skel" style="height:48px;width:100%;border-radius:12px"></div>
      </div>

    </div>
  </div>

  <!-- HOW IT WORKS — statis, langsung tampil -->
  <div class="how-section">
    <div class="how-title">Cara Berlangganan</div>
    <div class="steps">
      <div class="step">
        <div class="step-num">1</div>
        <div class="step-text">
          <strong>Login dengan Google</strong>
          <span>Kamu butuh akun untuk mengaktifkan premium.</span>
        </div>
      </div>
      <div class="step">
        <div class="step-num">2</div>
        <div class="step-text">
          <strong>Copy User ID kamu</strong>
          <span>User ID otomatis muncul setelah login. Paste di kolom pesan Sociabuzz.</span>
        </div>
      </div>
      <div class="step">
        <div class="step-num">3</div>
        <div class="step-text">
          <strong>Donasi Rp 15.000 via Sociabuzz</strong>
          <span>Klik "Bayar Sekarang" dan selesaikan pembayaran.</span>
        </div>
      </div>
      <div class="step">
        <div class="step-num">4</div>
        <div class="step-text">
          <strong>Premium aktif otomatis ✓</strong>
          <span>Dalam detik setelah bayar, akun langsung upgrade 1 bulan.</span>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
const SOCIABUZZ_URL = 'https://sociabuzz.com/dayynime/tribe';
const SUPABASE_URL  = 'https://mafnnqttvkdgqqxczqyt.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hZm5ucXR0dmtkZ3FxeGN6cXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzQyMDEsImV4cCI6MjA4NzQ1MDIwMX0.YRh1oWVKnn4tyQNRbcPhlSyvr7V_1LseWN7VjcImb-Y';

// Baca user & token langsung dari localStorage (sama seperti admin.html)
function getLocalUser() {
  try { return JSON.parse(localStorage.getItem('sb_user')); } catch { return null; }
}
function getLocalToken() {
  return localStorage.getItem('sb_access_token') || null;
}

async function checkPremium(userId) {
  try {
    const token = getLocalToken();
    const res = await fetch(
      `${SUPABASE_URL}/rest/v1/user_premium?user_id=eq.${userId}&select=is_active,expires_at`,
      { headers: {
        'apikey': SUPABASE_ANON,
        'Authorization': token ? `Bearer ${token}` : `Bearer ${SUPABASE_ANON}`
      }}
    );
    if (!res.ok) return false;
    const rows = await res.json();
    if (!rows.length) return false;
    const row = rows[0];
    if (!row.is_active) return false;
    if (!row.expires_at) return { active: true };
    const exp = new Date(row.expires_at);
    return exp > new Date() ? { active: true, expires_at: row.expires_at } : false;
  } catch { return false; }
}

async function initPremiumPage() {
  const section = document.getElementById('premUserSection');
  try {
    const user  = getLocalUser();
    const token = getLocalToken();

    // Sudah premium — cek langsung ke Supabase
    if (user && user.id) {
      const prem = await checkPremium(user.id);
      if (prem) {
        const exp = prem.expires_at
          ? new Date(prem.expires_at).toLocaleDateString('id-ID', {day:'numeric',month:'long',year:'numeric'})
          : 'Selamanya';
        section.innerHTML = `
          <div class="prem-active">
            <div class="icon">✦</div>
            <h3>Kamu Sudah Premium!</h3>
            <p>Aktif hingga ${exp}</p>
          </div>
          <a href="/home" class="btn-pay" style="text-decoration:none;margin-top:4px">&#9654; &nbsp;Mulai Nonton</a>
        `;
        return;
      }

      // Login tapi belum premium → tampilkan UID + tombol bayar
      const uid = user.id || '';
      section.innerHTML = `
        <div class="uid-box">
          <div class="uid-label">User ID kamu — paste ke kolom pesan Sociabuzz</div>
          <div class="uid-row">
            <span class="uid-val" id="uidVal">${uid}</span>
            <button class="uid-copy" onclick="copyUID()">Copy</button>
          </div>
          <p class="uid-hint">&#9888; Jangan hapus User ID ini saat isi pesan di Sociabuzz agar premium aktif otomatis.</p>
        </div>
        <button class="btn-pay" onclick="handlePay()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
          Bayar Sekarang — Rp 15.000
        </button>
        <p class="btn-pay-note">Diarahkan ke Sociabuzz &bull; Transfer Bank, QRIS, E-Wallet</p>
      `;
      return;
    }

    // Belum login sama sekali
    section.innerHTML = `
      <p style="font-size:12px;color:var(--text3);margin:0 0 4px">Login dulu untuk mendapatkan User ID kamu.</p>
      <a href="/auth/login" class="btn-login-g">
        <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.5 0 6.6 1.2 9.1 3.2l6.8-6.8C35.8 2.5 30.2 0 24 0 14.7 0 6.8 5.4 2.9 13.3l7.9 6.1C12.7 13.1 17.9 9.5 24 9.5z"/><path fill="#4A90D9" d="M46.1 24.5c0-1.6-.1-3.1-.4-4.5H24v8.5h12.4c-.5 2.8-2.1 5.2-4.5 6.8l7 5.4C43 36.8 46.1 31.1 46.1 24.5z"/><path fill="#34A853" d="M10.8 28.6c-.3-1-.5-2-.5-2.6 0-1.6.3-3.1.8-4.6l-7.9-6.1A23.9 23.9 0 0 0 0 24c0 3.9.9 7.5 2.5 10.8l8.3-6.2z"/><path fill="#FBBC05" d="M24 48c6.2 0 11.4-2 15.2-5.5l-7-5.4c-2 1.4-4.6 2.2-8.2 2.2-6.1 0-11.3-3.6-13.2-8.7l-8.3 6.2C6.8 42.6 14.7 48 24 48z"/></svg>
        Login dengan Google
      </a>
    `;
  } catch(e) {
    section.innerHTML = `<p style="color:var(--text3);font-size:12px;text-align:center">Gagal memuat. Coba refresh halaman.</p>`;
  }
}

function copyUID() {
  const val = document.getElementById('uidVal')?.textContent || '';
  navigator.clipboard.writeText(val).then(() => {
    const btn = document.querySelector('.uid-copy');
    if (!btn) return;
    btn.textContent = '✓ Copied!';
    btn.style.color = '#4caf7d';
    setTimeout(() => { btn.textContent = 'Copy'; btn.style.color = ''; }, 2000);
  });
}

function handlePay() {
  const uid = document.getElementById('uidVal')?.textContent || '';
  window.open(`${SOCIABUZZ_URL}?message=${encodeURIComponent('PREMIUM:' + uid)}`, '_blank');
}

initPremiumPage();
</script>
{% endblock %}
