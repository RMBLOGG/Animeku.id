{% extends "base.html" %}
{% block title %}Admin Dashboard â€” Animeku.id{% endblock %}

{% block head %}
<style>
/* â”€â”€ ADMIN PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.admin-page {
  max-width: 1100px;
  margin: 0 auto;
  padding: 16px 16px 48px;
  min-height: 100vh;
}

/* Access Denied */
.admin-denied {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 60vh;
  gap: 16px;
  text-align: center;
}
.admin-denied h2 {
  font-family: var(--font-head);
  font-size: 32px;
  color: var(--accent);
  letter-spacing: 2px;
}
.admin-denied p { color: var(--text2); font-size: 14px; }

/* Header */
.admin-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 12px;
}
.admin-title {
  font-family: var(--font-head);
  font-size: 28px;
  letter-spacing: 2px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.admin-badge-title {
  padding: 3px 10px;
  background: linear-gradient(135deg, #f4a261, #e76f1b);
  border-radius: 6px;
  font-size: 12px;
  font-weight: 800;
  color: #000;
  font-family: var(--font-mono);
  letter-spacing: 1px;
}

/* Tabs */
.admin-tabs {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
  margin-bottom: 20px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 6px;
}
.admin-tab {
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  color: var(--text2);
  cursor: pointer;
  transition: var(--trans);
  border: none;
  background: none;
  font-family: var(--font-body);
  display: flex;
  align-items: center;
  gap: 6px;
}
.admin-tab:hover { color: var(--text); background: rgba(255,255,255,0.05); }
.admin-tab.active { background: var(--accent); color: #fff; }

/* Tab Panes */
.admin-pane { display: none; }
.admin-pane.active { display: block; }

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 24px;
}
.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 20px 16px;
  text-align: center;
}
.stat-value {
  font-family: var(--font-head);
  font-size: 36px;
  color: var(--text);
  letter-spacing: 1px;
  line-height: 1;
  margin-bottom: 6px;
}
.stat-value.accent { color: var(--accent); }
.stat-value.gold   { color: var(--gold); }
.stat-value.green  { color: #4caf7d; }
.stat-label {
  font-size: 11px;
  color: var(--text3);
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Section card */
.admin-section {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  overflow: visible;
  margin-bottom: 16px;
}
.admin-section-header {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
  flex-wrap: wrap;
}
.admin-section-title {
  font-size: 13px;
  font-weight: 700;
  color: var(--text);
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.admin-section-body { padding: 0; overflow-x: auto; -webkit-overflow-scrolling: touch; }

/* Table */
.admin-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.admin-table th {
  padding: 10px 16px;
  text-align: left;
  font-size: 11px;
  font-weight: 700;
  color: var(--text3);
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 1px;
  border-bottom: 1px solid var(--border);
  background: var(--bg2);
}
.admin-table td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  color: var(--text2);
  vertical-align: middle;
}
.admin-table tr:last-child td { border-bottom: none; }
.admin-table tr:hover td { background: rgba(255,255,255,0.02); }

/* User row */
.user-info {
  display: flex;
  align-items: center;
  gap: 10px;
}
.user-info img {
  width: 32px; height: 32px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}
.user-avatar-ph {
  width: 32px; height: 32px;
  border-radius: 50%;
  background: var(--bg3);
  border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px;
  color: var(--text3);
  flex-shrink: 0;
}
.user-name { font-weight: 600; color: var(--text); font-size: 13px; }
.user-sub  { font-size: 11px; color: var(--text3); font-family: var(--font-mono); }

/* Badges */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 2px 8px;
  border-radius: 99px;
  font-size: 11px;
  font-weight: 700;
  font-family: var(--font-mono);
}
.badge-admin  { background: rgba(244,162,97,0.15); color: #f4a261; border: 1px solid rgba(244,162,97,0.3); }
.badge-user   { background: rgba(139,146,165,0.1); color: var(--text3); border: 1px solid var(--border); }
.badge-anon   { background: rgba(85,93,112,0.1);  color: var(--text3); border: 1px solid var(--border); font-style: italic; }
.badge-banned { background: rgba(230,57,70,0.15); color: var(--accent); border: 1px solid rgba(230,57,70,0.3); }

/* Buttons */
.btn {
  padding: 6px 12px;
  border-radius: 7px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: var(--trans);
  font-family: var(--font-body);
}
.btn-danger  { background: rgba(230,57,70,0.15); color: var(--accent); border: 1px solid rgba(230,57,70,0.3); }
.btn-danger:hover  { background: rgba(230,57,70,0.3); }
.btn-success { background: rgba(76,175,125,0.15); color: #4caf7d; border: 1px solid rgba(76,175,125,0.3); }
.btn-success:hover { background: rgba(76,175,125,0.3); }
.btn-primary { background: var(--accent); color: #fff; }
.btn-primary:hover { background: var(--accent2); }
.btn-gold    { background: rgba(244,162,97,0.15); color: var(--gold); border: 1px solid rgba(244,162,97,0.3); }
.btn-gold:hover { background: rgba(244,162,97,0.3); }
.btn-sm { padding: 4px 9px; font-size: 11px; }

/* Message preview */
.msg-preview {
  max-width: 260px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: var(--text2);
}

/* Popup editor */
.popup-editor {
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-label {
  font-size: 12px;
  font-weight: 700;
  color: var(--text3);
  font-family: var(--font-mono);
  text-transform: uppercase;
  letter-spacing: 1px;
}
.form-input, .form-textarea {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 10px 14px;
  color: var(--text);
  font-family: var(--font-body);
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
  user-select: text;
  -webkit-user-select: text;
}
.form-input:focus, .form-textarea:focus { border-color: rgba(230,57,70,0.4); }
.form-textarea { resize: vertical; min-height: 80px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
@media(max-width: 500px) { .form-row { grid-template-columns: 1fr; } }

/* Toast */
.admin-toast {
  position: fixed;
  bottom: 24px; right: 24px;
  padding: 10px 18px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 13px;
  color: var(--text);
  z-index: 9999;
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  animation: toastIn 0.3s ease both;
}
@keyframes toastIn {
  from { opacity:0; transform:translateY(10px); }
  to   { opacity:1; transform:none; }
}
.admin-toast.error { border-color: rgba(230,57,70,0.4); color: var(--accent); }
.admin-toast.success { border-color: rgba(76,175,125,0.4); color: #4caf7d; }

/* Empty state */
.empty-row td {
  text-align: center;
  padding: 32px !important;
  color: var(--text3);
  font-size: 13px;
}

/* Loading */
.loading-row td {
  text-align: center;
  padding: 32px !important;
  color: var(--text3);
  font-size: 13px;
}

/* Refresh btn */
.refresh-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 7px;
  background: rgba(255,255,255,0.05);
  border: 1px solid var(--border);
  color: var(--text2);
  font-size: 12px;
  cursor: pointer;
  transition: var(--trans);
}
.refresh-btn:hover { color: var(--text); background: rgba(255,255,255,0.08); }

/* Search input */
.search-input {
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 7px 12px;
  color: var(--text);
  font-size: 13px;
  outline: none;
  width: 200px;
  transition: border-color 0.2s;
  user-select: text;
  -webkit-user-select: text;
}
.search-input:focus { border-color: rgba(230,57,70,0.4); }

/* Maintenance toggle */
.toggle-wrap {
  display: flex;
  align-items: center;
  gap: 12px;
}
.toggle {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}
.toggle input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute;
  inset: 0;
  background: var(--bg3);
  border: 1px solid var(--border);
  border-radius: 99px;
  cursor: pointer;
  transition: 0.3s;
}
.toggle-slider:before {
  content: "";
  position: absolute;
  width: 16px; height: 16px;
  left: 3px; bottom: 3px;
  background: var(--text3);
  border-radius: 50%;
  transition: 0.3s;
}
.toggle input:checked + .toggle-slider { background: var(--accent); border-color: var(--accent); }
.toggle input:checked + .toggle-slider:before { transform: translateX(20px); background: #fff; }
.toggle-label { font-size: 14px; color: var(--text2); }

/* Chart bar */
.chart-bar-wrap { padding: 16px 20px; }
.chart-bar-item { margin-bottom: 14px; }
.chart-bar-label {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: var(--text2);
  margin-bottom: 5px;
}
.chart-bar-track {
  height: 6px;
  background: var(--bg3);
  border-radius: 99px;
  overflow: hidden;
}
.chart-bar-fill {
  height: 100%;
  border-radius: 99px;
  background: linear-gradient(to right, var(--accent), var(--accent2));
  transition: width 0.8s cubic-bezier(0.4,0,0.2,1);
}
</style>
{% endblock %}

{% block content %}
<div class="admin-page" id="adminPage" style="display:none">

  <!-- Header -->
  <div class="admin-header">
    <div class="admin-title">
      Dashboard <span class="admin-badge-title">â­ ADMIN</span>
    </div>
    <div style="font-size:13px;color:var(--text3);font-family:var(--font-mono)" id="adminWelcome"></div>
  </div>

  <!-- Tabs -->
  <div class="admin-tabs">
    <button class="admin-tab active" onclick="switchTab('stats')" id="tab-stats">
      ğŸ“Š Statistik
    </button>
    <button class="admin-tab" onclick="switchTab('chat')" id="tab-chat">
      ğŸ’¬ Chat
    </button>
    <button class="admin-tab" onclick="switchTab('comments')" id="tab-comments">
      ğŸ—¨ï¸ Komentar
    </button>
    <button class="admin-tab" onclick="switchTab('users')" id="tab-users">
      ğŸ‘¥ User
    </button>
    <button class="admin-tab" onclick="switchTab('popup')" id="tab-popup">
      ğŸ“¢ Popup
    </button>
    <button class="admin-tab" onclick="switchTab('pending')" id="tab-pending">
      â³ Premium Pending <span id="pendingBadge" style="display:none;background:#e63946;color:#fff;border-radius:99px;padding:1px 7px;font-size:10px;margin-left:4px">0</span>
    </button>
    <button class="admin-tab" onclick="switchTab('settings')" id="tab-settings">
      âš™ï¸ Pengaturan
    </button>
  </div>

  <!-- â”€â”€ STATISTIK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="admin-pane active" id="pane-stats">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value accent" id="stat-users">â€”</div>
        <div class="stat-label">Total User</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-chat">â€”</div>
        <div class="stat-label">Pesan Chat</div>
      </div>
      <div class="stat-card">
        <div class="stat-value gold" id="stat-comments">â€”</div>
        <div class="stat-label">Komentar Anime</div>
      </div>
      <div class="stat-card">
        <div class="stat-value green" id="stat-online">â€”</div>
        <div class="stat-label">Online Sekarang</div>
      </div>
    </div>

    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">ğŸ‘‘ User Paling Aktif di Chat</div>
        <button class="refresh-btn" onclick="loadStats()">â†» Refresh</button>
      </div>
      <div class="admin-section-body">
        <div class="chart-bar-wrap" id="activeUsersChart">
          <div style="color:var(--text3);font-size:13px">Memuat...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="admin-pane" id="pane-chat">
    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">ğŸ’¬ Semua Pesan Chat</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="text" class="search-input" placeholder="Cari pesan..." oninput="filterChat(this.value)" id="chatSearch">
          <button class="refresh-btn" onclick="loadChatMessages()">â†» Refresh</button>
        </div>
      </div>
      <div class="admin-section-body">
        <table class="admin-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Pesan</th>
              <th>Waktu</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="chatTableBody">
            <tr class="loading-row"><td colspan="4">Memuat...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ KOMENTAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="admin-pane" id="pane-comments">
    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">ğŸ—¨ï¸ Semua Komentar Anime</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="text" class="search-input" placeholder="Cari komentar..." oninput="filterComments(this.value)" id="commentSearch">
          <button class="refresh-btn" onclick="loadComments()">â†» Refresh</button>
        </div>
      </div>
      <div class="admin-section-body">
        <table class="admin-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Anime</th>
              <th>Komentar</th>
              <th>Waktu</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="commentTableBody">
            <tr class="loading-row"><td colspan="5">Memuat...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ USER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="admin-pane" id="pane-users">
    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">ğŸ‘¥ Daftar User</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input type="text" class="search-input" placeholder="Cari user..." oninput="filterUsers(this.value)" id="userSearch">
          <button class="refresh-btn" onclick="loadUsers()">â†» Refresh</button>
        </div>
      </div>
      <div class="admin-section-body">
        <table class="admin-table">
          <thead>
            <tr>
              <th>User</th>
              <th>Role</th>
              <th>Pesan Chat</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="userTableBody">
            <tr class="loading-row"><td colspan="5">Memuat...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- â”€â”€ POPUP EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="admin-pane" id="pane-popup">
    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">ğŸ“¢ Edit Popup Pemberitahuan</div>
        <span style="font-size:11px;color:var(--text3)">Perubahan langsung tersimpan ke Supabase</span>
      </div>
      <div class="admin-section-body">
        <div class="popup-editor">
          <div class="form-group">
            <label class="form-label">Judul Popup</label>
            <input type="text" class="form-input" id="popupTitle" placeholder="Pemberitahuan !!" value="Pemberitahuan !!">
          </div>
          <div class="form-group">
            <label class="form-label">Isi Teks (paragraf 1)</label>
            <textarea class="form-textarea" id="popupText1" placeholder="Website ini sepenuhnya dikelola oleh...">Website ini sepenuhnya dikelola oleh <strong>Dayynime</strong>.<br>Kami berkomitmen menghadirkan platform streaming yang bersih, aman, dan <strong>Tanpa Iklan Sama Sekali.</strong></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Isi Teks (paragraf 2)</label>
            <textarea class="form-textarea" id="popupText2" placeholder="Jika kamu ingin Berkontribusi...">Jika kamu ingin <strong>Berkontribusi</strong> untuk biaya server kami,<br>silakan klik tombol <strong>Dukung ANIMEKU.ID</strong> di bawah. ğŸ™</textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Link Tombol Dukung</label>
              <input type="text" class="form-input" id="popupDonateLink" placeholder="https://sociabuzz.com/...">
            </div>
            <div class="form-group">
              <label class="form-label">Link Tombol APK</label>
              <input type="text" class="form-input" id="popupApkLink" placeholder="https://...">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Teks Tombol Dukung</label>
            <input type="text" class="form-input" id="popupDonateText" placeholder="Dukung" value="Dukung">
          </div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="btn btn-primary" onclick="savePopupConfig()">ğŸ’¾ Simpan Perubahan</button>
            <button class="btn" style="border:1px solid var(--border);color:var(--text2)" onclick="loadPopupConfig()">â†» Reset</button>
          </div>
          <div id="popupSaveMsg" style="font-size:12px;color:#4caf7d;display:none">âœ“ Berhasil disimpan!</div>
        </div>
      </div>
    </div>

    <!-- Preview -->
    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">ğŸ‘ï¸ Preview Popup</div>
        <button class="btn btn-sm" style="border:1px solid var(--border);color:var(--text2)" onclick="previewPopup()">Lihat Preview</button>
      </div>
      <div style="padding:16px;font-size:13px;color:var(--text3)">
        Klik "Lihat Preview" untuk melihat tampilan popup sebelum disimpan.
      </div>
    </div>
  </div>

  <!-- â”€â”€ PREMIUM PENDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="admin-pane" id="pane-pending">

    <!-- Stats row -->
    <div class="stats-grid" style="grid-template-columns:repeat(auto-fill,minmax(150px,1fr));margin-bottom:16px">
      <div class="stat-card">
        <div class="stat-value accent" id="stat-pending">â€”</div>
        <div class="stat-label">Pending</div>
      </div>
      <div class="stat-card">
        <div class="stat-value green" id="stat-granted">â€”</div>
        <div class="stat-label">Granted</div>
      </div>
      <div class="stat-card">
        <div class="stat-value gold" id="stat-pendingAmount">â€”</div>
        <div class="stat-label">Total Nominal</div>
      </div>
    </div>

    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">â³ Donasi Tanpa Email â€” Perlu Approve Manual</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="refresh-btn" onclick="loadPending()">â†» Refresh</button>
        </div>
      </div>
      <div class="admin-section-body">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Donatur</th>
              <th>Nominal</th>
              <th>Pesan</th>
              <th>Waktu</th>
              <th>Status</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody id="pendingTableBody">
            <tr class="loading-row"><td colspan="6">Memuat...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Grant Manual Form -->
    <div class="admin-section" style="margin-top:16px">
      <div class="admin-section-header">
        <div class="admin-section-title">ğŸ Grant Premium Manual</div>
      </div>
      <div class="popup-editor">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Email User</label>
            <input type="email" class="form-input" id="grantEmail" placeholder="user@gmail.com">
          </div>
          <div class="form-group">
            <label class="form-label">Durasi</label>
            <select class="form-input" id="grantDays">
              <option value="30">1 Bulan (30 hari)</option>
              <option value="90">3 Bulan (90 hari)</option>
              <option value="365">1 Tahun (365 hari)</option>
              <option value="7">7 Hari (trial)</option>
            </select>
          </div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btn btn-success" onclick="grantManual()">âœ… Grant Premium</button>
          <span id="grantMsg" style="font-size:12px;display:none"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ PENGATURAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="admin-pane" id="pane-settings">
    <div class="admin-section">
      <div class="admin-section-header">
        <div class="admin-section-title">âš™ï¸ Pengaturan Site</div>
      </div>
      <div style="padding:20px;display:flex;flex-direction:column;gap:20px">

        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--bg2);border-radius:var(--radius);border:1px solid var(--border)">
          <div>
            <div style="font-weight:600;color:var(--text);font-size:14px;margin-bottom:3px">Mode Maintenance</div>
            <div style="font-size:12px;color:var(--text3)">Tampilkan halaman maintenance ke semua pengunjung</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="maintenanceToggle" onchange="toggleMaintenance(this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--bg2);border-radius:var(--radius);border:1px solid var(--border)">
          <div>
            <div style="font-weight:600;color:var(--text);font-size:14px;margin-bottom:3px">Popup Pemberitahuan</div>
            <div style="font-size:12px;color:var(--text3)">Aktifkan/nonaktifkan popup saat pengunjung masuk</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="popupToggle" checked onchange="togglePopupSetting(this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div style="display:flex;align-items:center;justify-content:space-between;padding:14px;background:var(--bg2);border-radius:var(--radius);border:1px solid var(--border)">
          <div>
            <div style="font-weight:600;color:var(--text);font-size:14px;margin-bottom:3px">Live Chat</div>
            <div style="font-size:12px;color:var(--text3)">Aktifkan/nonaktifkan halaman live chat</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="chatToggle" checked onchange="toggleChatSetting(this.checked)">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <div style="padding:14px;background:var(--bg2);border-radius:var(--radius);border:1px solid var(--border)">
          <div style="font-weight:600;color:var(--text);font-size:14px;margin-bottom:12px">ğŸ—‘ï¸ Hapus Semua Pesan Chat</div>
          <div style="font-size:12px;color:var(--text3);margin-bottom:12px">Hapus seluruh riwayat pesan di live chat. Tindakan ini tidak bisa dibatalkan!</div>
          <button class="btn btn-danger" onclick="clearAllChat()">ğŸ—‘ï¸ Hapus Semua Pesan Chat</button>
        </div>

        <div style="padding:14px;background:var(--bg2);border-radius:var(--radius);border:1px solid var(--border)">
          <div style="font-weight:600;color:var(--text);font-size:14px;margin-bottom:12px">ğŸ“‹ Info Admin</div>
          <div style="font-size:12px;color:var(--text3);font-family:var(--font-mono);line-height:2">
            Admin ID: <span style="color:var(--gold)" id="adminIdDisplay">â€”</span><br>
            Session: <span style="color:#4caf7d" id="adminSessionDisplay">Active</span>
          </div>
        </div>

      </div>
    </div>
  </div>

</div>

<!-- Access Denied -->
<div class="admin-denied" id="adminDenied" style="display:none">
  <div style="font-size:48px">ğŸš«</div>
  <h2>AKSES DITOLAK</h2>
  <p>Halaman ini hanya bisa diakses oleh Admin.<br>Login dengan akun admin terlebih dahulu.</p>
  <a href="/auth/login" class="btn btn-primary" style="margin-top:8px">Login</a>
</div>
{% endblock %}

{% block scripts %}
<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SUPABASE_URL  = "https://mafnnqttvkdgqqxczqyt.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hZm5ucXR0dmtkZ3FxeGN6cXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzQyMDEsImV4cCI6MjA4NzQ1MDIwMX0.YRh1oWVKnn4tyQNRbcPhlSyvr7V_1LseWN7VjcImb-Y";
const ADMIN_IDS     = ["c5ec3983-dbec-4e23-b6f6-2196fb4d5265"];

// â”€â”€ DATA CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allChatMessages = [];
let allComments     = [];
let allUsers        = [];
let bannedUsers     = JSON.parse(localStorage.getItem("admin_banned") || "[]");
let currentTab      = "stats";

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("DOMContentLoaded", () => {
  let user = null;
  try { user = JSON.parse(localStorage.getItem("sb_user")); } catch {}

  if (!user || !ADMIN_IDS.includes(user.id)) {
    document.getElementById("adminDenied").style.display = "flex";
    return;
  }

  document.getElementById("adminPage").style.display = "block";
  document.getElementById("adminWelcome").textContent = "Halo, " + user.name + " ğŸ‘‹";
  document.getElementById("adminIdDisplay").textContent = user.id;

  loadStats();
  loadChatMessages();
  loadComments();
  loadUsers();
  loadPopupConfig();
  loadSiteSettings();
  loadPending();
  loadPendingCount();
});

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sbH() {
  const token = localStorage.getItem("sb_access_token");
  return {
    "apikey": SUPABASE_ANON,
    "Content-Type": "application/json",
    "Authorization": token ? `Bearer ${token}` : `Bearer ${SUPABASE_ANON}`,
  };
}

function fmtTime(iso) {
  if (!iso) return "â€”";
  return new Date(iso).toLocaleString("id-ID", { day:"2-digit", month:"short", hour:"2-digit", minute:"2-digit" });
}

function escH(s) {
  return (s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function toast(msg, type="") {
  const el = document.createElement("div");
  el.className = "admin-toast " + type;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

function userAvatar(u) {
  if (u.user_avatar) return `<img src="${escH(u.user_avatar)}" alt="">`;
  return `<div class="user-avatar-ph">${escH((u.user_name||"?")[0].toUpperCase())}</div>`;
}

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  document.querySelectorAll(".admin-tab").forEach(t => t.classList.remove("active"));
  document.querySelectorAll(".admin-pane").forEach(p => p.classList.remove("active"));
  document.getElementById("tab-" + tab).classList.add("active");
  document.getElementById("pane-" + tab).classList.add("active");
  currentTab = tab;
}

// â”€â”€ STATISTIK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStats() {
  try {
    // Total chat messages
    const chatRes = await fetch(`${SUPABASE_URL}/rest/v1/chat_messages?room_id=eq.global&select=user_id,user_name,is_anon`, { headers: sbH() });
    const chatData = chatRes.ok ? await chatRes.json() : [];
    document.getElementById("stat-chat").textContent = chatData.length;

    // Total comments
    const comRes = await fetch(`${SUPABASE_URL}/rest/v1/anime_comments?select=id`, { headers: sbH() });
    const comData = comRes.ok ? await comRes.json() : [];
    document.getElementById("stat-comments").textContent = comData.length;

    // Online users
    const cutoff = new Date(Date.now() - 60000).toISOString();
    const onRes = await fetch(`${SUPABASE_URL}/rest/v1/chat_presence?last_seen=gte.${cutoff}&select=user_id`, { headers: sbH() });
    const onData = onRes.ok ? await onRes.json() : [];
    document.getElementById("stat-online").textContent = onData.length;

    // Unique users (non-anon)
    const uniqueUsers = [...new Set(chatData.filter(m => !m.is_anon).map(m => m.user_id))];
    document.getElementById("stat-users").textContent = uniqueUsers.length;

    // Active users chart
    const counts = {};
    chatData.forEach(m => {
      const key = m.is_anon ? "Anonim" : (m.user_name || "User");
      counts[key] = (counts[key] || 0) + 1;
    });
    const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,5);
    const max = sorted[0]?.[1] || 1;
    const chart = document.getElementById("activeUsersChart");
    if (!sorted.length) { chart.innerHTML = `<div style="color:var(--text3);font-size:13px">Belum ada data</div>`; return; }
    chart.innerHTML = sorted.map(([name, count]) => `
      <div class="chart-bar-item">
        <div class="chart-bar-label"><span>${escH(name)}</span><span>${count} pesan</span></div>
        <div class="chart-bar-track"><div class="chart-bar-fill" style="width:${(count/max*100).toFixed(1)}%"></div></div>
      </div>
    `).join("");
  } catch(e) { console.error(e); }
}

// â”€â”€ CHAT MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadChatMessages() {
  const tbody = document.getElementById("chatTableBody");
  tbody.innerHTML = `<tr class="loading-row"><td colspan="4">Memuat...</td></tr>`;
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/chat_messages?room_id=eq.global&order=created_at.desc&limit=100&select=*`, { headers: sbH() });
    if (!res.ok) throw new Error();
    allChatMessages = await res.json();
    renderChatTable(allChatMessages);
  } catch { tbody.innerHTML = `<tr class="empty-row"><td colspan="4">Gagal memuat data</td></tr>`; }
}

function renderChatTable(msgs) {
  const tbody = document.getElementById("chatTableBody");
  if (!msgs.length) { tbody.innerHTML = `<tr class="empty-row"><td colspan="4">Tidak ada pesan</td></tr>`; return; }
  tbody.innerHTML = msgs.map(m => `
    <tr id="crow-${m.id}">
      <td>
        <div class="user-info">
          ${m.user_avatar ? `<img src="${escH(m.user_avatar)}" alt="">` : `<div class="user-avatar-ph">${escH((m.user_name||"?")[0])}</div>`}
          <div>
            <div class="user-name">${escH(m.is_anon ? "Anonim" : m.user_name)}</div>
            <div class="user-sub">${m.is_anon ? "anonim" : escH(m.user_id?.slice(0,8)+"...")}</div>
          </div>
        </div>
      </td>
      <td><div class="msg-preview" title="${escH(m.content)}">${escH(m.content)}</div></td>
      <td style="white-space:nowrap;color:var(--text3);font-size:12px;font-family:var(--font-mono)">${fmtTime(m.created_at)}</td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn btn-sm btn-danger" onclick="deleteChatMsg('${m.id}')">ğŸ—‘ï¸ Hapus</button>
          ${!m.is_anon ? `<button class="btn btn-sm btn-gold" onclick="banUser('${escH(m.user_id)}','${escH(m.user_name)}')">ğŸš« Ban</button>` : ""}
        </div>
      </td>
    </tr>
  `).join("");
}

function filterChat(q) {
  const filtered = allChatMessages.filter(m =>
    (m.content||"").toLowerCase().includes(q.toLowerCase()) ||
    (m.user_name||"").toLowerCase().includes(q.toLowerCase())
  );
  renderChatTable(filtered);
}

async function deleteChatMsg(id) {
  if (!confirm("Hapus pesan ini?")) return;
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/chat_messages?id=eq.${id}`, { method: "DELETE", headers: sbH() });
    if (!res.ok) throw new Error();
    allChatMessages = allChatMessages.filter(m => m.id !== id);
    document.getElementById("crow-" + id)?.remove();
    toast("âœ“ Pesan dihapus", "success");
  } catch { toast("Gagal hapus pesan", "error"); }
}

// â”€â”€ KOMENTAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadComments() {
  const tbody = document.getElementById("commentTableBody");
  tbody.innerHTML = `<tr class="loading-row"><td colspan="5">Memuat...</td></tr>`;
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/anime_comments?order=created_at.desc&limit=100&select=*`, { headers: sbH() });
    if (!res.ok) throw new Error();
    allComments = await res.json();
    renderCommentTable(allComments);
  } catch { tbody.innerHTML = `<tr class="empty-row"><td colspan="5">Gagal memuat data</td></tr>`; }
}

function renderCommentTable(comments) {
  const tbody = document.getElementById("commentTableBody");
  if (!comments.length) { tbody.innerHTML = `<tr class="empty-row"><td colspan="5">Tidak ada komentar</td></tr>`; return; }
  tbody.innerHTML = comments.map(c => `
    <tr id="comrow-${c.id}">
      <td>
        <div class="user-info">
          ${c.user_avatar ? `<img src="${escH(c.user_avatar)}" alt="">` : `<div class="user-avatar-ph">${escH((c.user_name||"?")[0])}</div>`}
          <div class="user-name">${escH(c.user_name||"User")}</div>
        </div>
      </td>
      <td style="color:var(--accent);font-size:12px;font-family:var(--font-mono)">${escH(c.anime_slug||"â€”")}</td>
      <td><div class="msg-preview" title="${escH(c.content)}">${escH(c.content)}</div></td>
      <td style="white-space:nowrap;color:var(--text3);font-size:12px;font-family:var(--font-mono)">${fmtTime(c.created_at)}</td>
      <td>
        <button class="btn btn-sm btn-danger" onclick="deleteComment('${c.id}')">ğŸ—‘ï¸ Hapus</button>
      </td>
    </tr>
  `).join("");
}

function filterComments(q) {
  const filtered = allComments.filter(c =>
    (c.content||"").toLowerCase().includes(q.toLowerCase()) ||
    (c.user_name||"").toLowerCase().includes(q.toLowerCase()) ||
    (c.anime_slug||"").toLowerCase().includes(q.toLowerCase())
  );
  renderCommentTable(filtered);
}

async function deleteComment(id) {
  if (!confirm("Hapus komentar ini?")) return;
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/anime_comments?id=eq.${id}`, { method: "DELETE", headers: sbH() });
    if (!res.ok) throw new Error();
    allComments = allComments.filter(c => c.id !== id);
    document.getElementById("comrow-" + id)?.remove();
    toast("âœ“ Komentar dihapus", "success");
  } catch { toast("Gagal hapus komentar", "error"); }
}

// â”€â”€ USERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUsers() {
  const tbody = document.getElementById("userTableBody");
  tbody.innerHTML = `<tr class="loading-row"><td colspan="5">Memuat...</td></tr>`;
  try {
    // Ambil unique users dari chat messages
    const res = await fetch(`${SUPABASE_URL}/rest/v1/chat_messages?room_id=eq.global&select=user_id,user_name,user_avatar,is_anon`, { headers: sbH() });
    if (!res.ok) throw new Error();
    const msgs = await res.json();

    // Aggregate per user
    const userMap = {};
    msgs.forEach(m => {
      if (!userMap[m.user_id]) {
        userMap[m.user_id] = { user_id: m.user_id, user_name: m.user_name, user_avatar: m.user_avatar, is_anon: m.is_anon, msg_count: 0 };
      }
      userMap[m.user_id].msg_count++;
    });
    allUsers = Object.values(userMap).sort((a,b) => b.msg_count - a.msg_count);
    renderUserTable(allUsers);
  } catch { tbody.innerHTML = `<tr class="empty-row"><td colspan="5">Gagal memuat data</td></tr>`; }
}

function renderUserTable(users) {
  const tbody = document.getElementById("userTableBody");
  if (!users.length) { tbody.innerHTML = `<tr class="empty-row"><td colspan="5">Tidak ada data user</td></tr>`; return; }
  tbody.innerHTML = users.map(u => {
    const isAdmin  = ADMIN_IDS.includes(u.user_id);
    const isBanned = bannedUsers.includes(u.user_id);
    return `
    <tr id="urow-${u.user_id}">
      <td>
        <div class="user-info">
          ${u.user_avatar ? `<img src="${escH(u.user_avatar)}" alt="">` : `<div class="user-avatar-ph">${escH((u.user_name||"?")[0])}</div>`}
          <div>
            <div class="user-name">${escH(u.is_anon ? "Anonim" : u.user_name)}</div>
            <div class="user-sub">${escH(u.user_id?.slice(0,12)+"...")}</div>
          </div>
        </div>
      </td>
      <td>
        ${isAdmin  ? `<span class="badge badge-admin">â­ ADMIN</span>` :
          u.is_anon ? `<span class="badge badge-anon">Anonim</span>` :
                      `<span class="badge badge-user">User</span>`}
      </td>
      <td style="font-family:var(--font-mono);color:var(--text2)">${u.msg_count}</td>
      <td>
        ${isBanned ? `<span class="badge badge-banned">ğŸš« Banned</span>` : `<span style="color:#4caf7d;font-size:12px">âœ“ Aktif</span>`}
      </td>
      <td>
        ${!isAdmin && !u.is_anon ? `
          ${isBanned
            ? `<button class="btn btn-sm btn-success" onclick="unbanUser('${escH(u.user_id)}')">âœ“ Unban</button>`
            : `<button class="btn btn-sm btn-danger" onclick="banUser('${escH(u.user_id)}','${escH(u.user_name)}')">ğŸš« Ban</button>`
          }
        ` : "â€”"}
      </td>
    </tr>
  `}).join("");
}

function filterUsers(q) {
  const filtered = allUsers.filter(u =>
    (u.user_name||"").toLowerCase().includes(q.toLowerCase()) ||
    (u.user_id||"").toLowerCase().includes(q.toLowerCase())
  );
  renderUserTable(filtered);
}

function banUser(uid, name) {
  if (!confirm(`Ban user "${name}"? Mereka tidak bisa mengirim pesan.`)) return;
  if (!bannedUsers.includes(uid)) bannedUsers.push(uid);
  localStorage.setItem("admin_banned", JSON.stringify(bannedUsers));
  toast(`ğŸš« ${name} telah di-ban`, "success");
  renderUserTable(allUsers);
}

function unbanUser(uid) {
  bannedUsers = bannedUsers.filter(id => id !== uid);
  localStorage.setItem("admin_banned", JSON.stringify(bannedUsers));
  toast("âœ“ User di-unban", "success");
  renderUserTable(allUsers);
}

// â”€â”€ POPUP CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPopupConfig() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/site_config?key=eq.popup_config&select=*`, { headers: sbH() });
    if (!res.ok) return;
    const data = await res.json();
    if (data.length && data[0].value) {
      const cfg = typeof data[0].value === "string" ? JSON.parse(data[0].value) : data[0].value;
      if (cfg.title)       document.getElementById("popupTitle").value      = cfg.title;
      if (cfg.text1)       document.getElementById("popupText1").value      = cfg.text1;
      if (cfg.text2)       document.getElementById("popupText2").value      = cfg.text2;
      if (cfg.donateLink)  document.getElementById("popupDonateLink").value = cfg.donateLink;
      if (cfg.apkLink)     document.getElementById("popupApkLink").value    = cfg.apkLink;
      if (cfg.donateText)  document.getElementById("popupDonateText").value = cfg.donateText;
    }
  } catch {}
}

async function savePopupConfig() {
  const cfg = {
    title:      document.getElementById("popupTitle").value,
    text1:      document.getElementById("popupText1").value,
    text2:      document.getElementById("popupText2").value,
    donateLink: document.getElementById("popupDonateLink").value,
    apkLink:    document.getElementById("popupApkLink").value,
    donateText: document.getElementById("popupDonateText").value,
  };
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/site_config`, {
      method: "POST",
      headers: { ...sbH(), "Prefer": "resolution=merge-duplicates" },
      body: JSON.stringify({ key: "popup_config", value: cfg }),
    });
    if (!res.ok) throw new Error();
    const msg = document.getElementById("popupSaveMsg");
    msg.style.display = "block";
    setTimeout(() => msg.style.display = "none", 3000);
    toast("âœ“ Popup berhasil disimpan!", "success");
  } catch { toast("Gagal menyimpan popup", "error"); }
}

function previewPopup() {
  sessionStorage.removeItem("annShown");
  window.location.reload();
}

// â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSiteSettings() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/site_config?key=eq.site_settings&select=value`, { headers: sbH() });
    if (!res.ok) return;
    const data = await res.json();
    if (data.length && data[0].value) {
      const cfg = data[0].value;
      const maintenanceEl = document.getElementById("maintenanceToggle");
      const popupEl       = document.getElementById("popupToggle");
      const chatEl        = document.getElementById("chatToggle");
      if (maintenanceEl) maintenanceEl.checked = !!cfg.maintenance;
      if (popupEl)       popupEl.checked       = !cfg.popup_disabled;
      if (chatEl)        chatEl.checked         = !cfg.chat_disabled;
    }
  } catch(e) { console.error("Gagal load site settings:", e); }
}

async function _saveSiteSettings(patch) {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/site_config?key=eq.site_settings&select=value`, { headers: sbH() });
  const data = res.ok ? await res.json() : [];
  const current = (data.length && data[0].value) ? data[0].value : {};
  const updated = { ...current, ...patch };
  const saveRes = await fetch(`${SUPABASE_URL}/rest/v1/site_config`, {
    method: "POST",
    headers: { ...sbH(), "Prefer": "resolution=merge-duplicates" },
    body: JSON.stringify({ key: "site_settings", value: updated }),
  });
  if (!saveRes.ok) throw new Error("Gagal simpan ke Supabase");
}

async function toggleMaintenance(on) {
  try {
    await _saveSiteSettings({ maintenance: on });
    toast(on ? "âš ï¸ Mode maintenance aktif" : "âœ“ Mode maintenance dinonaktifkan", on ? "error" : "success");
  } catch { toast("Gagal update maintenance", "error"); }
}

async function togglePopupSetting(on) {
  try {
    await _saveSiteSettings({ popup_disabled: !on });
    toast(on ? "âœ“ Popup diaktifkan" : "Popup dinonaktifkan", "success");
  } catch { toast("Gagal update popup setting", "error"); }
}

async function toggleChatSetting(on) {
  try {
    await _saveSiteSettings({ chat_disabled: !on });
    toast(on ? "âœ“ Live chat diaktifkan" : "Live chat dinonaktifkan", "success");
  } catch { toast("Gagal update chat setting", "error"); }
}


// â”€â”€ PREMIUM PENDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allPending = [];

async function loadPending() {
  const tbody = document.getElementById("pendingTableBody");
  tbody.innerHTML = `<tr class="loading-row"><td colspan="6">Memuat...</td></tr>`;
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/pending_premium?order=created_at.desc&limit=100&select=*`, { headers: sbH() });
    if (!res.ok) throw new Error();
    allPending = await res.json();
    renderPendingTable(allPending);

    // Update stats
    const pending  = allPending.filter(p => p.status === "pending").length;
    const granted  = allPending.filter(p => p.status === "granted").length;
    const totalAmt = allPending.filter(p => p.status === "pending").reduce((s,p) => s + (p.amount||0), 0);
    document.getElementById("stat-pending").textContent = pending;
    document.getElementById("stat-granted").textContent = granted;
    document.getElementById("stat-pendingAmount").textContent = "Rp" + totalAmt.toLocaleString("id-ID");

    // Badge di tab
    const badge = document.getElementById("pendingBadge");
    if (pending > 0) { badge.style.display = "inline"; badge.textContent = pending; }
    else badge.style.display = "none";
  } catch(e) {
    tbody.innerHTML = `<tr class="empty-row"><td colspan="6">Gagal memuat data. Pastikan tabel pending_premium sudah dibuat.</td></tr>`;
  }
}

function renderPendingTable(rows) {
  const tbody = document.getElementById("pendingTableBody");
  if (!rows.length) {
    tbody.innerHTML = `<tr class="empty-row"><td colspan="6">ğŸ‰ Tidak ada donasi pending!</td></tr>`;
    return;
  }
  tbody.innerHTML = rows.map(p => {
    const isPending = p.status === "pending";
    const statusHtml = isPending
      ? `<span class="badge" style="background:rgba(244,162,97,0.15);color:#f4a261;border:1px solid rgba(244,162,97,0.3)">â³ Pending</span>`
      : `<span class="badge badge-user" style="color:#4caf7d;border-color:rgba(76,175,125,0.3)">âœ… Granted</span>`;
    const aksi = isPending ? `
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn btn-sm btn-success" onclick="openGrantFromPending('${p.id}', ${p.amount})">
          âœ… Grant
        </button>
        <button class="btn btn-sm btn-danger" onclick="rejectPending('${p.id}')">
          âœ— Tolak
        </button>
      </div>` : "â€”";
    const rp = "Rp" + (p.amount||0).toLocaleString("id-ID");
    return `
      <tr id="prow-${p.id}">
        <td><div class="user-name">${escH(p.donor_name||"â€”")}</div></td>
        <td style="font-weight:700;color:var(--gold);font-family:var(--font-mono)">${rp}</td>
        <td><div class="msg-preview" title="${escH(p.message||"")}">${escH(p.message||"(kosong)")}</div></td>
        <td style="color:var(--text3);font-size:12px;font-family:var(--font-mono);white-space:nowrap">${fmtTime(p.created_at)}</td>
        <td>${statusHtml}</td>
        <td>${aksi}</td>
      </tr>`;
  }).join("");
}

function openGrantFromPending(pendingId, amount) {
  // Isi otomatis durasi sesuai nominal
  const paket = { 15000: "30", 35000: "90", 100000: "365" };
  const days = paket[amount] || "30";
  document.getElementById("grantDays").value = days;
  document.getElementById("grantEmail").focus();
  // Simpan pending ID untuk di-update setelah grant
  document.getElementById("grantEmail").dataset.pendingId = pendingId;
  toast("Isi email user lalu klik Grant Premium â†“", "");
  // Scroll ke form grant
  document.querySelector("#pane-pending .popup-editor").scrollIntoView({ behavior: "smooth" });
}

async function grantManual() {
  const email     = document.getElementById("grantEmail").value.trim();
  const days      = parseInt(document.getElementById("grantDays").value);
  const pendingId = document.getElementById("grantEmail").dataset.pendingId || null;
  const msgEl     = document.getElementById("grantMsg");

  if (!email) { toast("Isi email dulu!", "error"); return; }

  msgEl.style.display = "inline";
  msgEl.style.color   = "var(--text3)";
  msgEl.textContent   = "â³ Memproses...";

  try {
    const adminSecret = prompt("Masukkan ADMIN_SECRET kamu:");
    if (!adminSecret) { msgEl.style.display = "none"; return; }

    // Cari user by email via endpoint backend
    const res = await fetch("/api/premium/grant-by-email", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-Admin-Secret": adminSecret },
      body: JSON.stringify({ email, days, pending_id: pendingId })
    });
    const json = await res.json();

    if (res.ok && json.ok) {
      msgEl.style.color   = "#4caf7d";
      msgEl.textContent   = `âœ… Premium aktif s/d ${json.expired_at?.slice(0,10)}`;
      toast(`âœ… Premium granted ke ${email}!`, "success");
      document.getElementById("grantEmail").value = "";
      document.getElementById("grantEmail").dataset.pendingId = "";
      loadPending();
    } else {
      msgEl.style.color   = "var(--accent)";
      msgEl.textContent   = "âŒ " + (json.error || "Gagal");
      toast("âŒ " + (json.error || "Gagal grant premium"), "error");
    }
  } catch(e) {
    msgEl.style.color = "var(--accent)";
    msgEl.textContent = "âŒ Error jaringan";
    toast("Error: " + e.message, "error");
  }
}

async function rejectPending(id) {
  if (!confirm("Tolak donasi ini? Status akan diubah ke 'rejected'.")) return;
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/pending_premium?id=eq.${id}`, {
      method: "PATCH",
      headers: { ...sbH(), "Prefer": "return=representation" },
      body: JSON.stringify({ status: "rejected" })
    });
    if (!res.ok) throw new Error();
    toast("âœ“ Donasi ditolak", "success");
    loadPending();
  } catch { toast("Gagal update status", "error"); }
}

// Load pending count on init
async function loadPendingCount() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/pending_premium?status=eq.pending&select=id`, { headers: sbH() });
    if (!res.ok) return;
    const data = await res.json();
    const badge = document.getElementById("pendingBadge");
    if (data.length > 0) { badge.style.display = "inline"; badge.textContent = data.length; }
  } catch {}
}

  if (!confirm("âš ï¸ Hapus SEMUA pesan chat? Tindakan ini tidak bisa dibatalkan!")) return;
  if (!confirm("Yakin? Semua pesan akan hilang permanen!")) return;
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/chat_messages?room_id=eq.global`, { method: "DELETE", headers: sbH() });
    if (!res.ok) throw new Error();
    allChatMessages = [];
    renderChatTable([]);
    toast("âœ“ Semua pesan chat dihapus", "success");
    loadStats();
  } catch { toast("Gagal hapus semua pesan", "error"); }
}
</script>
{% endblock %}