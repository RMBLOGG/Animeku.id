{% extends "base.html" %}
{% block title %}{{ data.detail.title if data and data.detail else 'Detail Anime' }} — Animeku.id
<script>
var _SB  = 'https://mafnnqttvkdgqqxczqyt.supabase.co';
var _ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hZm5ucXR0dmtkZ3FxeGN6cXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzQyMDEsImV4cCI6MjA4NzQ1MDIwMX0.YRh1oWVKnn4tyQNRbcPhlSyvr7V_1LseWN7VjcImb-Y';

function goPremiumEp(btn) {
  btn.style.opacity = '0.5';
  btn.style.pointerEvents = 'none';
  var slug = btn.dataset.slug;
  var anime = btn.dataset.anime;
  var token = localStorage.getItem('sb_access_token') || '';
  fetch('/api/premium/status', {
    headers: token ? { 'Authorization': 'Bearer ' + token } : {}
  })
    .then(function(r){ return r.json(); })
    .then(function(data){
      if (data.premium) {
        window.location.href = '/episode/' + slug + '?anime=' + anime;
      } else if (data.reason === 'not_logged_in') {
        window.location.href = '/auth/login';
      } else {
        window.location.href = '/premium';
      }
    })
    .catch(function(){
      btn.style.opacity = '';
      btn.style.pointerEvents = '';
      window.location.href = '/premium';
    });
}
</script>
{% endblock %}

{% block content %}
{% if data and data.detail %}
{% set d = data.detail %}

<div class="detail-hero" id="detailHero"
  data-anime-slug="{{ slug }}"
  data-anime-title="{{ d.title }}"
  data-anime-poster="{{ d.poster }}"
  data-anime-type="{{ d.info.type if d.info and d.info.type else '' }}">
  <div class="detail-backdrop" style="background-image: url('{{ d.poster }}')"></div>
  <div class="detail-content">
    <div class="detail-poster">
      <img src="{{ d.poster }}" alt="{{ d.title }}" onerror="this.src='/static/img/placeholder.svg'">
    </div>
    <div class="detail-info fade-up">
      <div>
        <h1 class="detail-title">{{ d.title }}</h1>
        {% if d.info and d.info.japanese %}
        <p class="detail-title-jp">{{ d.info.japanese }}</p>
        {% endif %}
      </div>

      <div class="badges-row">
        {% if d.info %}
          {% if d.info.type %}<span class="badge badge-type">{{ d.info.type }}</span>{% endif %}
          {% if d.info.status %}
            {% if 'Ongoing' in d.info.status or 'Airing' in d.info.status %}
              <span class="badge badge-status-ongoing">{{ d.info.status }}</span>
            {% else %}
              <span class="badge badge-status-completed">{{ d.info.status }}</span>
            {% endif %}
          {% endif %}
        {% endif %}
      </div>

      {% if d.info %}
      <div class="detail-stats">
        {% if d.info.score and d.info.score != 'N/A' %}
        <div class="stat"><span class="stat-label">⭐ Score</span><span class="stat-value score">{{ d.info.score }}</span></div>
        {% endif %}
        {% if d.info.total_episode %}
        <div class="stat"><span class="stat-label">Episode</span><span class="stat-value">{{ d.info.total_episode }}</span></div>
        {% endif %}
        {% if d.info.duration %}
        <div class="stat"><span class="stat-label">Durasi</span><span class="stat-value" style="font-size:15px">{{ d.info.duration }}</span></div>
        {% endif %}
        {% if d.info.released %}
        <div class="stat"><span class="stat-label">Rilis</span><span class="stat-value" style="font-size:14px">{{ d.info.released }}</span></div>
        {% endif %}
      </div>
      {% endif %}

      {% if d.genres %}
      <div class="genre-tags">
        {% for g in d.genres %}
        <a href="/genre/{{ g.slug }}" class="genre-tag">{{ g.name }}</a>
        {% endfor %}
      </div>
      {% endif %}

      {% if d.synopsis %}
      <div>
        <p class="synopsis-text" id="synopsisText">{{ d.synopsis }}</p>
        <span class="read-more" id="readMoreBtn">Baca selengkapnya <span class="read-more-arrow">↓</span></span>
      </div>
      {% endif %}

      <div class="detail-actions">
        {% if d.episodes and d.episodes | length > 0 %}
        <a href="/episode/{{ d.episodes[0].slug }}?anime={{ slug }}" class="btn btn-primary">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg>
          Tonton Sekarang
        </a>
        {% endif %}
        <button class="btn-watchlist" id="watchlistBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          <span id="watchlistBtnText">+ Watchlist</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- EPISODE LIST -->
{% if d.episodes and d.episodes | length > 0 %}
<div class="episodes-section" style="padding-top:40px">
  <div class="section-header" style="margin-bottom:16px">
    <h2 class="section-title">Daftar Episode</h2>
    <span style="color:var(--text3);font-size:13px">{{ d.episodes | length }} Episode</span>
  </div>

  <!-- Continue watching banner -->
  <div id="continueBanner"></div>

  <input type="text" id="epSearch" placeholder="Cari episode..."
    style="width:100%;max-width:300px;margin-bottom:16px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px 16px;color:var(--text);font-family:var(--font-body);font-size:14px;outline:none;display:block">

  <div class="episodes-grid" id="episodesGrid">
    {% set ep_count = d.episodes | length %}
    {% for ep in d.episodes %}
      {# Episode diurutkan terbaru → terlama, jadi ep1 ada di index terakhir #}
      {% set ep_num_from_end = ep_count - loop.index %}
      {% if ep_num_from_end >= 2 %}
        <button class="ep-btn ep-locked" data-ep="{{ ep.name | lower }}" data-slug="{{ ep.slug }}" data-anime="{{ slug }}" onclick="goPremiumEp(this)">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor"><path d="M18 8h-1V6A5 5 0 0 0 7 6v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V10a2 2 0 0 0-2-2zm-6 9a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm3.1-9H8.9V6a3.1 3.1 0 0 1 6.2 0v2z"/></svg>
          {{ ep.name }}
          <span class="ep-premium-badge">&#10022; Premium</span>
        </button>
      {% else %}
        <a href="/episode/{{ ep.slug }}?anime={{ slug }}" class="ep-btn ep-free" data-ep="{{ ep.name | lower }}">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg>
          {{ ep.name }}
          <span class="ep-free-badge">Gratis</span>
        </a>
      {% endif %}
    {% endfor %}
  </div>
</div>

<!-- Auto-unlock episode kalau user premium -->
<script>
(async function() {
  var token = localStorage.getItem('sb_access_token') || '';
  if (!token) return;
  try {
    var res = await fetch('/api/premium/status', {
      headers: { 'Authorization': 'Bearer ' + token }
    });
    var d = await res.json();
    if (!d.premium) return;

    // User premium → ganti semua tombol locked jadi link langsung
    document.querySelectorAll('.ep-locked').forEach(function(btn) {
      var a = document.createElement('a');
      a.href = '/episode/' + btn.dataset.slug + '?anime=' + btn.dataset.anime;
      a.className = 'ep-btn ep-free';
      a.dataset.ep = btn.dataset.ep;
      // Ambil nama episode dari teks btn (node ke-2)
      var epText = '';
      btn.childNodes.forEach(function(n) {
        if (n.nodeType === 3) epText += n.textContent.trim();
      });
      a.innerHTML =
        '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg> ' +
        epText +
        '<span class="ep-free-badge">✦ Unlocked</span>';
      btn.parentNode.replaceChild(a, btn);
    });
  } catch(e) {}
})();
</script>

{% endif %}

{% else %}
<div class="container empty-state">
  <h3>Anime tidak ditemukan</h3>
  <p>Coba cari anime lain atau kembali ke <a href="/" style="color:var(--accent)">halaman utama</a></p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if data and data.detail %}
{% set d = data.detail %}
<script>
// Watchlist button state
(function() {
  const slug = '{{ slug }}';
  const list = JSON.parse(localStorage.getItem('animeku_watchlist') || '[]');
  const inList = list.some(a => a.slug === slug);
  const btn  = document.getElementById('watchlistBtn');
  const txt  = document.getElementById('watchlistBtnText');
  if (inList && btn) { btn.classList.add('active'); txt.textContent = '✓ Di Watchlist'; }

  // Continue watching banner
  const prog  = JSON.parse(localStorage.getItem('animeku_progress') || '{}');
  const saved = prog[slug];
  if (saved) {
    const banner = document.getElementById('continueBanner');
    if (banner) banner.innerHTML = `
      <a href="/episode/${saved.epSlug}?anime=${slug}" class="continue-banner">
        <img src="{{ d.poster }}" alt="{{ d.title }}" onerror="this.src='/static/img/placeholder.svg'">
        <div class="continue-info">
          <div class="continue-label">⏯ LANJUT NONTON</div>
          <div class="continue-title">{{ d.title }}</div>
          <div class="continue-ep">${saved.epName}</div>
        </div>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color:var(--accent);flex-shrink:0"><path d="M5 3l14 9-14 9V3z"/></svg>
      </a>`;
  }

  // Episode search
  document.getElementById('epSearch')?.addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('.ep-btn').forEach(b => {
      b.style.display = b.dataset.ep.includes(q) ? '' : 'none';
    });
  });
})();
</script>
{% endif %}

<script>
// Smooth baca selengkapnya
(function() {
  var btn = document.getElementById('readMoreBtn');
  var text = document.getElementById('synopsisText');
  if (!btn || !text) return;

  var isExpanded = false;

  btn.addEventListener('click', function() {
    isExpanded = !isExpanded;
    if (isExpanded) {
      text.classList.add('expanded');
      btn.classList.add('open');
      btn.childNodes[0].textContent = 'Sembunyikan ';
    } else {
      text.classList.remove('expanded');
      btn.classList.remove('open');
      btn.childNodes[0].textContent = 'Baca selengkapnya ';
    }
  });
})();
</script>

<style>
/* ── Episode Premium Styles ── */
.ep-locked {
  position: relative;
  opacity: 0.7;
  cursor: pointer;
  background: none;
  font-family: var(--font-body);
  font-size: inherit;
  text-align: left;
  color: var(--text2);
  border: 1px solid var(--border);
  padding: inherit;
}
.ep-locked:hover { opacity: 1; color: var(--text); border-color: #f4a261; }
.ep-premium-badge {
  margin-left: auto;
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 20px;
  background: linear-gradient(135deg, #f4a261, #e76f1b);
  color: #000;
  font-weight: 700;
  letter-spacing: 0.5px;
  flex-shrink: 0;
}
.ep-free-badge {
  margin-left: auto;
  font-size: 10px;
  padding: 2px 7px;
  border-radius: 20px;
  background: rgba(76,175,125,0.2);
  color: #4caf7d;
  font-weight: 700;
  letter-spacing: 0.5px;
  flex-shrink: 0;
}

.premium-modal-btn {
  display: inline-block;
  padding: 12px 28px;
  border-radius: var(--radius);
  background: linear-gradient(135deg, #f4a261, #e76f1b);
  color: #000;
  font-weight: 700;
  font-size: 14px;
  text-decoration: none;
  margin: 4px;
  cursor: pointer;
  border: none;
}
.premium-modal-btn.secondary {
  background: var(--card2, rgba(255,255,255,0.08));
  color: var(--text);
  border: 1px solid var(--border);
}
</style>


{% endblock %}