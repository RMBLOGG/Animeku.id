{% extends "base.html" %}
{% block title %}{{ data.title if data else 'Nonton Episode' }} â€” Animeku.id{% endblock %}

{% block content %}
{% if data %}

{% set episodes = anime_data.detail.episodes if anime_data and anime_data.detail and anime_data.detail.episodes else [] %}
{% set current_idx = namespace(val=-1) %}
{% for ep in episodes %}
  {% if ep.slug == slug %}{% set current_idx.val = loop.index0 %}{% endif %}
{% endfor %}
{% set prev_ep = episodes[current_idx.val - 1] if current_idx.val > 0 else None %}
{% set next_ep = episodes[current_idx.val + 1] if current_idx.val >= 0 and current_idx.val < episodes|length - 1 else None %}

<div class="player-container">

  <!-- BREADCRUMB -->
  <div class="breadcrumb">
    <a href="/">Beranda</a>
    <span class="breadcrumb-sep">â€º</span>
    {% if anime_data and anime_data.detail %}
    <a href="/anime/{{ anime_slug }}" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:160px;display:inline-block">{{ anime_data.detail.title }}</a>
    <span class="breadcrumb-sep">â€º</span>
    {% endif %}
    {# Tampilkan hanya nama episode singkat di breadcrumb (misal "Episode 5") #}
    {% set ep_short = None %}
    {% for ep in episodes %}
      {% if ep.slug == slug %}{% set ep_short = ep.name %}{% endif %}
    {% endfor %}
    <span>{{ ep_short if ep_short else data.title }}</span>
  </div>

  <!-- JUDUL -->
  {# Judul singkat: pakai nama anime + nama episode jika tersedia #}
  {% if anime_data and anime_data.detail and ep_short %}
  <h1 class="player-title" style="margin-bottom:4px;font-size:clamp(16px,3vw,28px);line-height:1.3">
    {{ anime_data.detail.title }}
    <span style="color:var(--accent)"> â€” {{ ep_short }}</span>
  </h1>
  {% else %}
  <h1 class="player-title" style="margin-bottom:4px;font-size:clamp(16px,3vw,28px);line-height:1.3">{{ data.title }}</h1>
  {% endif %}
  <p style="color:var(--text3);font-size:13px;margin-bottom:16px">Animeku.id â€” Streaming Sub Indo</p>

  <!-- VIDEO PLAYER -->
  <div class="player-frame">
    {% if data.streams and data.streams | length > 0 %}
    <iframe id="playerIframe" src="{{ data.streams[0].url }}"
      allowfullscreen allow="autoplay; fullscreen"
      sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-presentation"
      referrerpolicy="no-referrer">
    </iframe>
    {% else %}
    <div class="player-placeholder">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M10 8l6 4-6 4V8z"/></svg>
      <p>Stream tidak tersedia untuk episode ini</p>
    </div>
    {% endif %}
  </div>

  <!-- SERVER TABS -->
  {% if data.streams and data.streams | length > 0 %}
  <div class="player-section">
    <p class="player-section-label">PILIH SERVER â€” Jika error, coba server lain</p>
    <div class="server-tabs">
      {% for stream in data.streams %}
      <button class="server-btn {% if loop.first %}active{% endif %}"
        data-url="{{ stream.url }}" onclick="switchServer(this)">
        {{ stream.name }}
      </button>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- NOTICE -->
  <div class="player-notice">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
    <span>Jika video tidak muncul, coba ganti server atau nonaktifkan ad blocker.</span>
  </div>

  <!-- ACTION BAR -->
  <div class="player-action-bar">
    {% if anime_slug %}
    <a href="/anime/{{ anime_slug }}" class="btn btn-ghost btn-sm">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      Detail Anime
    </a>
    {% else %}
    <a href="/" class="btn btn-ghost btn-sm">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
      Beranda
    </a>
    {% endif %}

    <div class="ep-prev-next">
      {% if prev_ep %}
      <a href="/episode/{{ prev_ep.slug }}?anime={{ anime_slug }}" class="btn btn-ghost btn-sm">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
        Prev
      </a>
      {% else %}
      <button class="btn btn-ghost btn-sm" disabled style="opacity:0.3">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
        Prev
      </button>
      {% endif %}

      {% if next_ep %}
      <a href="/episode/{{ next_ep.slug }}?anime={{ anime_slug }}" class="btn btn-primary btn-sm">
        Next
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
      </a>
      {% else %}
      <button class="btn btn-ghost btn-sm" disabled style="opacity:0.3">
        Next
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
      </button>
      {% endif %}
    </div>
  </div>

  <!-- DAFTAR EPISODE -->
  {% if episodes | length > 0 %}
  <div class="player-ep-section">
    <button class="player-ep-toggle" id="epToggleBtn" onclick="toggleEpList()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
      Daftar Episode ({{ episodes | length }})
    </button>
    <div class="hidden" id="epListGrid">
      <div class="episodes-grid" style="margin-top:12px">
        {% for ep in episodes %}
        <a href="/episode/{{ ep.slug }}?anime={{ anime_slug }}"
           class="ep-btn {% if ep.slug == slug %}active{% endif %}">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg>
          {{ ep.name }}
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

</div>

<script>
function switchServer(btn) {
  document.querySelectorAll('.server-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const iframe = document.getElementById('playerIframe');
  if (iframe) iframe.src = btn.dataset.url;
}
function toggleEpList() {
  document.getElementById('epListGrid').classList.toggle('hidden');
  document.getElementById('epToggleBtn').classList.toggle('open');
}
// Jalankan setelah main.js selesai load
document.addEventListener('DOMContentLoaded', function() {
  if (typeof saveEpisodeProgress === 'function') {
    saveEpisodeProgress(
      '{{ anime_slug }}',
      {{ (anime_data.detail.title if anime_data and anime_data.detail else data.title) | tojson }},
      {{ (anime_data.detail.poster if anime_data and anime_data.detail else '') | tojson }},
      '{{ slug }}',
      {{ data.title | tojson }}
    );
  }
});
</script>

<!-- KOMENTAR -->
<div class="container" style="max-width:860px;margin:0 auto;padding:0 16px 60px">
  <h3 style="font-size:16px;font-weight:600;margin-bottom:16px;color:var(--text1)">ðŸ’¬ Komentar</h3>
  <div id="commentFormWrap" style="margin-bottom:20px"></div>
  <div id="commentList" style="display:flex;flex-direction:column;gap:12px">
    <p style="color:var(--text3);font-size:13px">Memuat komentar...</p>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://mafnnqttvkdgqqxczqyt.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hZm5ucXR0dmtkZ3FxeGN6cXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzQyMDEsImV4cCI6MjA4NzQ1MDIwMX0.YRh1oWVKnn4tyQNRbcPhlSyvr7V_1LseWN7VjcImb-Y';
const ANIME_SLUG_COMMENT = '{{ anime_slug or slug }}';

// Ambil user dari localStorage
function getUser() {
  try { return JSON.parse(localStorage.getItem('sb_user')); } catch { return null; }
}
function getToken() {
  return localStorage.getItem('sb_access_token');
}

let currentUser = getUser();

async function initComments() {
  renderCommentForm(currentUser);
  loadComments();
}

function renderCommentForm(user) {
  const wrap = document.getElementById('commentFormWrap');
  if (user) {
    wrap.innerHTML = `
      <div style="display:flex;gap:10px;align-items:flex-start">
        <img src="${user.avatar||''}" alt="" width="32" height="32" style="border-radius:50%;object-fit:cover;flex-shrink:0;margin-top:4px">
        <div style="flex:1">
          <textarea id="commentInput" placeholder="Tulis komentar..." rows="2"
            style="width:100%;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text1);font-size:14px;resize:vertical;font-family:inherit"></textarea>
          <button onclick="submitComment()" class="btn btn-primary btn-sm" style="margin-top:8px">Kirim</button>
        </div>
      </div>`;
  } else {
    wrap.innerHTML = `<a href="/auth/login" class="btn btn-primary btn-sm">ðŸ”‘ Login untuk berkomentar</a>`;
  }
}

async function loadComments() {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/anime_comments?anime_slug=eq.${ANIME_SLUG_COMMENT}&order=created_at.desc&select=*`, {
    headers: { 'apikey': SUPABASE_ANON, 'Authorization': `Bearer ${SUPABASE_ANON}` }
  });
  const comments = await r.json();
  const list = document.getElementById('commentList');
  if (!Array.isArray(comments) || !comments.length) {
    list.innerHTML = '<p style="color:var(--text3);font-size:13px">Belum ada komentar. Jadilah yang pertama!</p>';
    return;
  }
  list.innerHTML = comments.map(c => `
    <div style="display:flex;gap:10px;background:var(--surface);border-radius:12px;padding:12px 14px">
      <img src="${c.user_avatar||'/static/img/placeholder.svg'}" alt="" width="32" height="32"
        style="border-radius:50%;object-fit:cover;flex-shrink:0">
      <div style="flex:1;min-width:0">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
          <span style="font-weight:600;font-size:13px;color:var(--text1)">${escHtml(c.user_name||'User')}</span>
          <span style="font-size:11px;color:var(--text3)">${timeAgo(c.created_at)}</span>
        </div>
        <p style="font-size:14px;color:var(--text2);margin:0;word-break:break-word">${escHtml(c.content)}</p>
        ${currentUser && currentUser.id === c.user_id ? `
        <button onclick="deleteComment('${c.id}')" style="background:none;border:none;color:var(--text3);font-size:11px;cursor:pointer;margin-top:6px;padding:0">Hapus</button>` : ''}
      </div>
    </div>`).join('');
}

async function submitComment() {
  const input = document.getElementById('commentInput');
  const content = (input.value||'').trim();
  if (!content) return;
  const token = getToken();
  const user = getUser();
  if (!token || !user) { alert('Login dulu ya!'); return; }
  const r = await fetch(`${SUPABASE_URL}/rest/v1/anime_comments`, {
    method: 'POST',
    headers: {
      'apikey': SUPABASE_ANON,
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation'
    },
    body: JSON.stringify({
      anime_slug: ANIME_SLUG_COMMENT,
      user_id: user.id,
      user_name: user.name,
      user_avatar: user.avatar,
      content
    })
  });
  if (r.ok) { input.value = ''; loadComments(); }
  else {
    const err = await r.json().catch(() => ({}));
    alert('Gagal kirim komentar: ' + (err.message || r.status));
  }
}

async function deleteComment(id) {
  if (!confirm('Hapus komentar ini?')) return;
  const token = getToken();
  await fetch(`${SUPABASE_URL}/rest/v1/anime_comments?id=eq.${id}`, {
    method: 'DELETE',
    headers: { 'apikey': SUPABASE_ANON, 'Authorization': `Bearer ${token}` }
  });
  loadComments();
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function timeAgo(iso) {
  const diff = (Date.now() - new Date(iso)) / 1000;
  if (diff < 60) return 'baru saja';
  if (diff < 3600) return Math.floor(diff/60) + ' menit lalu';
  if (diff < 86400) return Math.floor(diff/3600) + ' jam lalu';
  return Math.floor(diff/86400) + ' hari lalu';
}

initComments();
</script>

{% else %}
<div class="container empty-state" style="padding-top:80px">
  <h3>Episode tidak ditemukan</h3>
  <p><a href="/" style="color:var(--accent)">Kembali ke beranda</a></p>
</div>
{% endif %}
{% endblock %}
