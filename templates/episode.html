{% extends "base.html" %}
{% block title %}{{ data.title if data else 'Nonton Episode' }} ‚Äî Animeku.id{% endblock %}

{% block content %}
{% if data %}

{% set episodes = anime_data.detail.episodes if anime_data and anime_data.detail and anime_data.detail.episodes else [] %}
{% set current_idx = namespace(val=-1) %}
{% for ep in episodes %}
  {% if ep.slug == slug %}{% set current_idx.val = loop.index0 %}{% endif %}
{% endfor %}
{# API mengurutkan episode dari terbaru ke terlama (index 0 = episode terbaru) #}
{# Prev = episode lebih lama = index+1, Next = episode lebih baru = index-1 #}
{% set prev_ep = episodes[current_idx.val + 1] if current_idx.val >= 0 and current_idx.val < episodes|length - 1 else None %}
{% set next_ep = episodes[current_idx.val - 1] if current_idx.val > 0 else None %}

<style>
.player-container { padding: 4px 4px 24px !important; }
</style>

<div class="player-container">

  <!-- BREADCRUMB & JUDUL -->
  {# Pakai namespace agar variabel bisa diakses di luar loop #}
  {% set ep_ns = namespace(name='') %}
  {% for ep in episodes %}
    {% if ep.slug == slug %}{% set ep_ns.name = ep.name %}{% endif %}
  {% endfor %}

  <div class="breadcrumb">
    <a href="/">Beranda</a>
    <span class="breadcrumb-sep">‚Ä∫</span>
    {% set _aslug = anime_slug or (data.anime_id if data else '') %}
    {% if anime_data and anime_data.detail %}
    <a href="/anime/{{ _aslug }}" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:150px;display:inline-block">{{ anime_data.detail.title }}</a>
    <span class="breadcrumb-sep">‚Ä∫</span>
    {% elif _aslug %}
    <a href="/anime/{{ _aslug }}" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:150px;display:inline-block">{{ _aslug | replace("-", " ") | title }}</a>
    <span class="breadcrumb-sep">‚Ä∫</span>
    {% endif %}
    {# Ambil nomor episode dari data.title, misal "Tamon-kun Episode 9 Sub Indo" ‚Üí "Episode 9" #}
    {% if data.title %}
      {% set parts = data.title.split() %}
      {% set ep_idx = namespace(val=-1) %}
      {% for i in range(parts|length) %}
        {% if parts[i].lower() == 'episode' %}{% set ep_idx.val = i %}{% endif %}
      {% endfor %}
      <span>{% if ep_idx.val >= 0 %}Episode {{ parts[ep_idx.val + 1] if ep_idx.val + 1 < parts|length else '' }}{% else %}Episode{% endif %}</span>
    {% else %}
      <span>{{ ep_ns.name if ep_ns.name else 'Episode' }}</span>
    {% endif %}
  </div>

  <!-- JUDUL -->
  {# data.title dari API samehadaku sudah berisi judul lengkap, misal "One Piece Episode 9 Sub Indo" #}
  <h1 class="player-title" style="margin-bottom:4px;font-size:clamp(15px,2.5vw,24px);line-height:1.3">
    {% if data.title %}
      {{ data.title }}
    {% elif anime_data and anime_data.detail %}
      {{ anime_data.detail.title }}{% if ep_ns.name %}<span style="color:var(--accent)"> ‚Äî {{ ep_ns.name }}</span>{% endif %}
    {% else %}
      Nonton Episode
    {% endif %}
  </h1>
  <p style="color:var(--text3);font-size:13px;margin-bottom:16px">Animeku.id ‚Äî Streaming Sub Indo</p>

  <!-- VIDEO PLAYER -->
  <div class="player-frame" style="position:relative">

    <!-- PLACEHOLDER: tampil sebelum server dipilih -->
    <div id="playerPlaceholder" style="
      position:absolute;inset:0;
      background:#0a0a0a;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      gap:20px;z-index:5;border-radius:0;
    ">
      <!-- Logo ANIMEKU.ID huruf per huruf -->
      <div class="ph-logo" id="phLogo">
        <span class="ph-a">A</span><span class="ph-n">N</span><span class="ph-i">I</span><span class="ph-m">M</span><span class="ph-e">E</span><span class="ph-k">K</span><span class="ph-u">U</span><span class="ph-dot">.</span><span class="ph-id">ID</span>
      </div>
      <p id="phSubtitle" style="color:rgba(255,255,255,0.45);font-size:13px;letter-spacing:2px;font-family:var(--font-mono,'monospace');text-transform:uppercase;opacity:0;transform:translateY(12px);transition:none">
        ‚Üì Pilih kualitas untuk memulai
      </p>
    </div>

    {% if locked %}
    <!-- PREMIUM LOCKED OVERLAY -->
    <div id="premiumOverlay" style="
      position:absolute;inset:0;z-index:20;
      background:linear-gradient(135deg,#0d0d0d 0%,#1a0a0a 100%);
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:18px;padding:32px;text-align:center;
    ">
      <div style="font-size:52px;line-height:1;filter:drop-shadow(0 0 20px rgba(230,57,70,0.5))">üîí</div>
      <div>
        <h2 style="color:#fff;font-size:clamp(16px,3vw,22px);font-weight:800;margin:0 0 8px;font-family:var(--font-head)">
          Episode Premium
        </h2>
        <p style="color:rgba(255,255,255,0.55);font-size:13px;margin:0;line-height:1.6;max-width:280px">
          {{ free_limit }} episode pertama gratis.<br>
          Episode ini hanya untuk member <span style="color:#e63946;font-weight:700">Premium</span>.
        </p>
      </div>
      <div style="display:flex;flex-direction:column;gap:10px;width:100%;max-width:240px">
        <a href="/premium" style="
          display:flex;align-items:center;justify-content:center;gap:8px;
          background:linear-gradient(135deg,#e63946,#c1121f);
          color:#fff;font-weight:700;font-size:14px;
          padding:12px 20px;border-radius:8px;text-decoration:none;
          box-shadow:0 4px 20px rgba(230,57,70,0.4);
          transition:transform 0.15s,box-shadow 0.15s;
          letter-spacing:0.5px;
        " onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 8px 28px rgba(230,57,70,0.5)'"
           onmouseout="this.style.transform='';this.style.boxShadow='0 4px 20px rgba(230,57,70,0.4)'">
          üöÄ Upgrade Premium
        </a>
        {% if not session.get('user') %}
        <a href="/auth/login" style="
          display:flex;align-items:center;justify-content:center;gap:8px;
          background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);
          color:rgba(255,255,255,0.75);font-weight:600;font-size:13px;
          padding:10px 20px;border-radius:8px;text-decoration:none;
          transition:background 0.15s;
        " onmouseover="this.style.background='rgba(255,255,255,0.13)'"
           onmouseout="this.style.background='rgba(255,255,255,0.08)'">
          üîë Login Dulu
        </a>
        {% endif %}
      </div>
      <p style="color:rgba(255,255,255,0.25);font-size:11px;margin:0;font-family:var(--font-mono)">
        ANIMEKU.ID PREMIUM
      </p>
    </div>
    {% endif %}

    <style>
    .ph-logo {
      display:flex;align-items:baseline;gap:2px;
      font-family:var(--font-head,'sans-serif');
      font-size:clamp(32px,8vw,52px);
      font-weight:900;
      letter-spacing:2px;
    }
    .ph-logo span {
      display:inline-block;
      opacity:0;
      transform:translateY(30px) scale(0.7);
      transition: none;
    }
    .ph-logo span.ph-visible {
      opacity:1;
      transform:translateY(0) scale(1);
      transition: opacity 0.45s cubic-bezier(.22,.68,0,1.4), transform 0.45s cubic-bezier(.22,.68,0,1.4);
    }
    .ph-a  { color:#e53935; }
    .ph-n  { color:#fff; }
    .ph-i  { color:#fff; }
    .ph-m  { color:#fff; }
    .ph-e  { color:#fff; }
    .ph-k  { color:#fff; }
    .ph-u  { color:#fff; }
    .ph-dot{ color:#e53935; font-size:0.6em; }
    .ph-id { color:var(--text2); font-size:0.7em; }
    </style>

    <script>
    (function() {
      function animateLogo() {
        var spans = document.querySelectorAll('#phLogo span');
        var subtitle = document.getElementById('phSubtitle');
        // reset
        spans.forEach(function(s) { s.classList.remove('ph-visible'); });
        if (subtitle) {
          subtitle.style.transition = 'none';
          subtitle.style.opacity = '0';
          subtitle.style.transform = 'translateY(12px)';
        }
        // animasi huruf
        spans.forEach(function(s, i) {
          setTimeout(function() { s.classList.add('ph-visible'); }, 150 + i * 90);
        });
        // subtitle muncul setelah semua huruf selesai
        var delay = 150 + spans.length * 90 + 100;
        setTimeout(function() {
          if (subtitle) {
            subtitle.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            subtitle.style.opacity = '1';
            subtitle.style.transform = 'translateY(0)';
          }
        }, delay);
      }
      document.addEventListener('DOMContentLoaded', animateLogo);
      window.animateLogoPlaceholder = animateLogo;
    })();
    </script>

    {% if data.streams and data.streams | length > 0 %}
    <iframe id="playerIframe" src="about:blank"
      allowfullscreen allow="autoplay; fullscreen"
      sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-presentation"
      referrerpolicy="no-referrer"
      style="position:relative;z-index:1">
    </iframe>
    {% else %}
    <div class="player-placeholder">
      <p>Stream tidak tersedia untuk episode ini</p>
    </div>
    {% endif %}
  </div>

  <!-- SERVER TABS: Pilih Resolusi ‚Üí Pilih Server -->
  {% if data.streams and data.streams | length > 0 %}
  <div class="player-section">
    <p class="player-section-label">PILIH KUALITAS</p>

    <!-- Step 1: Tombol Resolusi -->
    <div class="server-tabs" id="qualityTabs">
      {% set seen_q = namespace(list=[]) %}
      {% for stream in data.streams %}
        {% set q = stream.name.split()[-1] if stream.name.split() else '' %}
        {% if q not in seen_q.list %}
          {% set _ = seen_q.list.append(q) %}
          <button class="server-btn {% if loop.first %}active{% endif %}"
            data-quality="{{ q }}"
            onclick="selectQuality(this, '{{ q }}')">
            {{ q }}
          </button>
        {% endif %}
      {% endfor %}
    </div>

    <!-- Step 2: Daftar Server per Resolusi -->
    <p class="player-section-label" style="margin-top:14px">PILIH SERVER</p>
    {% set first_q = namespace(val='') %}
    {% for stream in data.streams %}
      {% if loop.first %}{% set first_q.val = stream.name.split()[-1] %}{% endif %}
    {% endfor %}

    {% set seen_q2 = namespace(list=[]) %}
    {% for stream in data.streams %}
      {% set q = stream.name.split()[-1] if stream.name.split() else '' %}
      {% if q not in seen_q2.list %}
        {% set _ = seen_q2.list.append(q) %}
        <div class="server-tabs server-group"
             id="group-{{ q }}"
             style="{{ '' if q == first_q.val else 'display:none' }}">
          {% for s in data.streams %}
            {% set sq = s.name.split()[-1] if s.name.split() else '' %}
            {% if sq == q %}
            <button class="server-btn"
              data-server-id="{{ s.serverId }}"
              data-url="{{ s.url if s.url else '' }}"
              onclick="switchServer(this)">
              {{ s.name.split()[:-1] | join(' ') if s.name.split()|length > 1 else s.name }}
            </button>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}

    <div id="serverLoading" style="display:none;color:var(--text3);font-size:13px;margin-top:8px">‚è≥ Memuat server...</div>
  </div>
  {% endif %}

  <!-- NOTICE -->
  <div class="player-notice">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
    <span>Jika video tidak muncul, coba ganti server atau nonaktifkan ad blocker.</span>
  </div>

  <!-- ACTION BAR -->
  <div class="player-action-bar">
    {% if anime_slug %}
    <a href="/anime/{{ anime_slug }}" class="btn btn-ghost btn-sm">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      Detail Anime
    </a>
    {% else %}
    <a href="/" class="btn btn-ghost btn-sm">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
      Beranda
    </a>
    {% endif %}

    <div class="ep-prev-next">
      {% if prev_ep %}
      <a href="/episode/{{ prev_ep.slug }}?anime={{ anime_slug }}" class="btn btn-ghost btn-sm">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
        Prev
      </a>
      {% else %}
      <button class="btn btn-ghost btn-sm" disabled style="opacity:0.3">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
        Prev
      </button>
      {% endif %}

      {% if next_ep %}
      <a href="/episode/{{ next_ep.slug }}?anime={{ anime_slug }}" class="btn btn-primary btn-sm">
        Next
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
      </a>
      {% else %}
      <button class="btn btn-ghost btn-sm" disabled style="opacity:0.3">
        Next
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
      </button>
      {% endif %}
    </div>
  </div>

  <!-- DAFTAR EPISODE -->
  {% if episodes | length > 0 %}
  <div class="player-ep-section">
    <button class="player-ep-toggle" id="epToggleBtn" onclick="toggleEpList()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
      Daftar Episode ({{ episodes | length }})
    </button>
    <div class="hidden" id="epListGrid">
      {% set total_eps = episodes | length %}
      <div class="episodes-grid" style="margin-top:12px">
        {% for ep in episodes %}
        {% set is_locked = loop.index0 < (total_eps - free_limit) %}
        <a href="/episode/{{ ep.slug }}?anime={{ anime_slug }}"
           class="ep-btn {% if ep.slug == slug %}active{% endif %}"
           {% if is_locked %}style="opacity:0.7"{% endif %}>
          {% if is_locked %}
          <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor" style="color:#e63946"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
          {% else %}
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg>
          {% endif %}
          {{ ep.name }}
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

</div>

<script>
function selectQuality(btn, quality) {
  // Highlight tombol resolusi aktif
  document.querySelectorAll('#qualityTabs .server-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  // Tampilkan grup server yang sesuai
  document.querySelectorAll('.server-group').forEach(g => g.style.display = 'none');
  const group = document.getElementById('group-' + quality);
  if (group) {
    group.style.display = 'flex';
    // Auto-klik server pertama di grup ini
    const firstSrv = group.querySelector('.server-btn');
    if (firstSrv) switchServer(firstSrv);
  }
}

async function switchServer(btn) {
  document.querySelectorAll('.server-group .server-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const iframe = document.getElementById('playerIframe');
  if (!iframe) return;

  const directUrl = btn.dataset.url;
  if (directUrl) {
    hidePlaceholder();
    iframe.src = directUrl;
    return;
  }

  const serverId = btn.dataset.serverId;
  if (!serverId) return;
  const loading = document.getElementById('serverLoading');
  if (loading) loading.style.display = 'block';
  try {
    const res  = await fetch(`/api/server/${serverId}`);
    const json = await res.json();
    if (json.url) {
      hidePlaceholder();
      iframe.src = json.url;
      btn.dataset.url = json.url;
    }
  } catch(e) {
    console.error('Failed to fetch server URL', e);
  } finally {
    if (loading) loading.style.display = 'none';
  }
}

function hidePlaceholder() {
  const ph = document.getElementById('playerPlaceholder');
  if (ph) {
    ph.style.transition = 'opacity 0.4s';
    ph.style.opacity = '0';
    setTimeout(() => ph.style.display = 'none', 400);
  }
}

function showPlaceholder() {
  const ph = document.getElementById('playerPlaceholder');
  if (ph) {
    ph.style.display = 'flex';
    ph.style.opacity = '0';
    requestAnimationFrame(function() {
      ph.style.transition = 'opacity 0.4s';
      ph.style.opacity = '1';
    });
    if (typeof window.animateLogoPlaceholder === 'function') {
      setTimeout(window.animateLogoPlaceholder, 200);
    }
  }
}

function toggleEpList() {
  document.getElementById('epListGrid').classList.toggle('hidden');
  document.getElementById('epToggleBtn').classList.toggle('open');
}

document.addEventListener('DOMContentLoaded', function() {
  // Auto-load server pertama
  const firstBtn = document.querySelector('.server-btn.active');
  if (firstBtn) switchServer(firstBtn);

  if (typeof saveEpisodeProgress === 'function') {
    saveEpisodeProgress(
      '{{ anime_slug }}',
      {{ (anime_data.detail.title if anime_data and anime_data.detail else data.title) | tojson }},
      {{ (anime_data.detail.poster if anime_data and anime_data.detail else '') | tojson }},
      '{{ slug }}',
      {{ data.title | tojson }}
    );
  }
});
</script>

<!-- KOMENTAR -->
<div class="container" style="max-width:860px;margin:0 auto;padding:0 16px 60px">

  <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
    <div style="width:3px;height:20px;background:var(--accent);border-radius:2px"></div>
    <h3 style="font-size:15px;font-weight:700;color:var(--text);font-family:var(--font-head);letter-spacing:1px;margin:0">KOMENTAR</h3>
  </div>

  <div id="commentFormWrap" style="margin-bottom:24px"></div>

  <div id="commentList" style="display:flex;flex-direction:column;gap:10px">
    <p style="color:var(--text3);font-size:13px;font-family:var(--font-mono)">Memuat komentar...</p>
  </div>
</div>

<style>
.comment-card {
  display: flex;
  gap: 12px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  transition: border-color 0.2s;
}
.comment-card:hover { border-color: rgba(230,57,70,0.2); }
.comment-avatar {
  width: 36px; height: 36px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
  border: 2px solid var(--border);
}
.comment-avatar-placeholder {
  width: 36px; height: 36px;
  border-radius: 50%;
  background: var(--accent);
  color: #fff;
  font-weight: 700;
  font-size: 14px;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  font-family: var(--font-head);
}
.comment-name {
  font-weight: 600;
  font-size: 13px;
  color: var(--text);
}
.comment-time {
  font-size: 11px;
  color: var(--text3);
  font-family: var(--font-mono);
}
.comment-body {
  font-size: 14px;
  color: var(--text2);
  margin: 6px 0 0;
  line-height: 1.6;
  word-break: break-word;
}
.comment-delete {
  background: none;
  border: none;
  color: var(--text3);
  font-size: 11px;
  cursor: pointer;
  padding: 0;
  margin-top: 8px;
  font-family: var(--font-mono);
  transition: color 0.2s;
}
.comment-delete:hover { color: var(--accent); }
.comment-input {
  width: 100%;
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 14px;
  color: var(--text);
  font-size: 14px;
  resize: vertical;
  font-family: var(--font-body);
  transition: border-color 0.2s;
  box-sizing: border-box;
}
.comment-input:focus {
  outline: none;
  border-color: rgba(230,57,70,0.45);
}
.comment-input::placeholder { color: var(--text3); }
</style>

<script>
const SUPABASE_URL = 'https://mafnnqttvkdgqqxczqyt.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hZm5ucXR0dmtkZ3FxeGN6cXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzQyMDEsImV4cCI6MjA4NzQ1MDIwMX0.YRh1oWVKnn4tyQNRbcPhlSyvr7V_1LseWN7VjcImb-Y';
const ANIME_SLUG_COMMENT = '{{ anime_slug or slug }}';

// Ambil user dari localStorage
function getUser() {
  try { return JSON.parse(localStorage.getItem('sb_user')); } catch { return null; }
}
function getToken() {
  return localStorage.getItem('sb_access_token');
}

let currentUser = getUser();

async function initComments() {
  renderCommentForm(currentUser);
  loadComments();
}

function renderCommentForm(user) {
  const wrap = document.getElementById('commentFormWrap');
  if (user) {
    const initial = (user.name || 'U')[0].toUpperCase();
    const avatarHtml = user.avatar
      ? `<img src="${user.avatar}" alt="" class="comment-avatar" style="margin-top:2px">`
      : `<div class="comment-avatar-placeholder" style="margin-top:2px">${initial}</div>`;
    wrap.innerHTML = `
      <div style="display:flex;gap:12px;align-items:flex-start;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px">
        ${avatarHtml}
        <div style="flex:1">
          <textarea id="commentInput" placeholder="Tulis komentar..." rows="2" class="comment-input"></textarea>
          <button onclick="submitComment()" class="btn btn-primary btn-sm" style="margin-top:10px">Kirim</button>
        </div>
      </div>`;
  } else {
    wrap.innerHTML = `<a href="/auth/login" class="btn btn-primary btn-sm">üîë Login untuk berkomentar</a>`;
  }
}

async function loadComments() {
  const r = await fetch(`${SUPABASE_URL}/rest/v1/anime_comments?anime_slug=eq.${ANIME_SLUG_COMMENT}&order=created_at.desc&select=*`, {
    headers: { 'apikey': SUPABASE_ANON, 'Authorization': `Bearer ${SUPABASE_ANON}` }
  });
  const comments = await r.json();
  const list = document.getElementById('commentList');
  if (!Array.isArray(comments) || !comments.length) {
    list.innerHTML = '<p style="color:var(--text3);font-size:13px;font-family:var(--font-mono)">Belum ada komentar. Jadilah yang pertama!</p>';
    return;
  }
  list.innerHTML = comments.map(c => {
    const initial = (c.user_name || 'U')[0].toUpperCase();
    const avatarHtml = c.user_avatar
      ? `<img src="${c.user_avatar}" alt="" class="comment-avatar">`
      : `<div class="comment-avatar-placeholder">${initial}</div>`;
    const deleteBtn = currentUser && currentUser.id === c.user_id
      ? `<button onclick="deleteComment('${c.id}')" class="comment-delete">‚Äî Hapus</button>`
      : '';
    return `
    <div class="comment-card">
      ${avatarHtml}
      <div style="flex:1;min-width:0">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <span class="comment-name">${escHtml(c.user_name||'User')}</span>
          <span class="comment-time">${timeAgo(c.created_at)}</span>
        </div>
        <p class="comment-body">${escHtml(c.content)}</p>
        ${deleteBtn}
      </div>
    </div>`;
  }).join('');
}

async function submitComment() {
  const input = document.getElementById('commentInput');
  const content = (input.value||'').trim();
  if (!content) return;
  const token = getToken();
  const user = getUser();
  if (!token || !user) { alert('Login dulu ya!'); return; }
  const r = await fetch(`${SUPABASE_URL}/rest/v1/anime_comments`, {
    method: 'POST',
    headers: {
      'apikey': SUPABASE_ANON,
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation'
    },
    body: JSON.stringify({
      anime_slug: ANIME_SLUG_COMMENT,
      user_id: user.id,
      user_name: user.name,
      user_avatar: user.avatar,
      content
    })
  });
  if (r.ok) { input.value = ''; loadComments(); }
  else {
    const err = await r.json().catch(() => ({}));
    alert('Gagal kirim komentar: ' + (err.message || r.status));
  }
}

async function deleteComment(id) {
  if (!confirm('Hapus komentar ini?')) return;
  const token = getToken();
  await fetch(`${SUPABASE_URL}/rest/v1/anime_comments?id=eq.${id}`, {
    method: 'DELETE',
    headers: { 'apikey': SUPABASE_ANON, 'Authorization': `Bearer ${token}` }
  });
  loadComments();
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function timeAgo(iso) {
  const diff = (Date.now() - new Date(iso)) / 1000;
  if (diff < 60) return 'baru saja';
  if (diff < 3600) return Math.floor(diff/60) + ' menit lalu';
  if (diff < 86400) return Math.floor(diff/3600) + ' jam lalu';
  return Math.floor(diff/86400) + ' hari lalu';
}

initComments();
</script>

{% else %}
<div class="container empty-state" style="padding-top:80px">
  <h3>Episode tidak ditemukan</h3>
  <p><a href="/" style="color:var(--accent)">Kembali ke beranda</a></p>
</div>
{% endif %}
{% endblock %}