{% extends "base.html" %}
{% block title %}{{ data.title if data else 'Nonton Episode' }} — Animeku.id{% endblock %}

{% block content %}
{% if data %}

{% set episodes = anime_data.detail.episodes if anime_data and anime_data.detail and anime_data.detail.episodes else [] %}
{% set current_idx = namespace(val=-1) %}
{% for ep in episodes %}
  {% if ep.slug == slug %}{% set current_idx.val = loop.index0 %}{% endif %}
{% endfor %}
{% set prev_ep = episodes[current_idx.val - 1] if current_idx.val > 0 else None %}
{% set next_ep = episodes[current_idx.val + 1] if current_idx.val >= 0 and current_idx.val < episodes|length - 1 else None %}

<div class="player-container">

  <!-- BREADCRUMB -->
  <div class="breadcrumb">
    <a href="/">Beranda</a>
    <span class="breadcrumb-sep">›</span>
    {% if anime_data and anime_data.detail %}
    <a href="/anime/{{ anime_slug }}">{{ anime_data.detail.title }}</a>
    <span class="breadcrumb-sep">›</span>
    {% endif %}
    <span>{{ data.title }}</span>
  </div>

  <!-- JUDUL -->
  <h1 class="player-title" style="margin-bottom:4px">{{ data.title }}</h1>
  <p style="color:var(--text3);font-size:13px;margin-bottom:16px">Animeku.id — Streaming Sub Indo</p>

  <!-- VIDEO PLAYER -->
  <div class="player-frame">
    {% if data.streams and data.streams | length > 0 %}
    <iframe id="playerIframe" src="{{ data.streams[0].url }}"
      allowfullscreen allow="autoplay; fullscreen"
      sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-presentation"
      referrerpolicy="no-referrer">
    </iframe>
    {% else %}
    <div class="player-placeholder">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M10 8l6 4-6 4V8z"/></svg>
      <p>Stream tidak tersedia untuk episode ini</p>
    </div>
    {% endif %}
  </div>

  <!-- SERVER TABS -->
  {% if data.streams and data.streams | length > 0 %}
  <div class="player-section">
    <p class="player-section-label">PILIH SERVER — Jika error, coba server lain</p>
    <div class="server-tabs">
      {% for stream in data.streams %}
      <button class="server-btn {% if loop.first %}active{% endif %}"
        data-url="{{ stream.url }}" onclick="switchServer(this)">
        {{ stream.name }}
      </button>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- NOTICE -->
  <div class="player-notice">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
    <span>Jika video tidak muncul, coba ganti server atau nonaktifkan ad blocker.</span>
  </div>

  <!-- ACTION BAR -->
  <div class="player-action-bar">
    {% if anime_slug %}
    <a href="/anime/{{ anime_slug }}" class="btn btn-ghost btn-sm">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      Detail Anime
    </a>
    {% else %}
    <a href="/" class="btn btn-ghost btn-sm">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
      Beranda
    </a>
    {% endif %}

    <div class="ep-prev-next">
      {% if prev_ep %}
      <a href="/episode/{{ prev_ep.slug }}?anime={{ anime_slug }}" class="btn btn-ghost btn-sm">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
        Prev
      </a>
      {% else %}
      <button class="btn btn-ghost btn-sm" disabled style="opacity:0.3">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
        Prev
      </button>
      {% endif %}

      {% if next_ep %}
      <a href="/episode/{{ next_ep.slug }}?anime={{ anime_slug }}" class="btn btn-primary btn-sm">
        Next
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
      </a>
      {% else %}
      <button class="btn btn-ghost btn-sm" disabled style="opacity:0.3">
        Next
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
      </button>
      {% endif %}
    </div>
  </div>

  <!-- DAFTAR EPISODE -->
  {% if episodes | length > 0 %}
  <div class="player-ep-section">
    <button class="player-ep-toggle" id="epToggleBtn" onclick="toggleEpList()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
      Daftar Episode ({{ episodes | length }})
    </button>
    <div class="hidden" id="epListGrid">
      <div class="episodes-grid" style="margin-top:12px">
        {% for ep in episodes %}
        <a href="/episode/{{ ep.slug }}?anime={{ anime_slug }}"
           class="ep-btn {% if ep.slug == slug %}active{% endif %}">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg>
          {{ ep.name }}
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

</div>

<script>
function switchServer(btn) {
  document.querySelectorAll('.server-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const iframe = document.getElementById('playerIframe');
  if (iframe) iframe.src = btn.dataset.url;
}
function toggleEpList() {
  document.getElementById('epListGrid').classList.toggle('hidden');
  document.getElementById('epToggleBtn').classList.toggle('open');
}
// Jalankan setelah main.js selesai load
document.addEventListener('DOMContentLoaded', function() {
  if (typeof saveEpisodeProgress === 'function') {
    saveEpisodeProgress(
      '{{ anime_slug }}',
      {{ (anime_data.detail.title if anime_data and anime_data.detail else data.title) | tojson }},
      {{ (anime_data.detail.poster if anime_data and anime_data.detail else '') | tojson }},
      '{{ slug }}',
      {{ data.title | tojson }}
    );
  }
});
</script>

{% else %}
<div class="container empty-state" style="padding-top:80px">
  <h3>Episode tidak ditemukan</h3>
  <p><a href="/" style="color:var(--accent)">Kembali ke beranda</a></p>
</div>
{% endif %}
{% endblock %}
