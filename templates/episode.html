{% extends "base.html" %}
{% block title %}{{ data.title if data else 'Nonton Episode' }} ‚Äî Animeku.id{% endblock %}

{% block content %}
{% if data %}

{% set episodes = anime_data.detail.episodes if anime_data and anime_data.detail and anime_data.detail.episodes else [] %}
{% set current_idx = namespace(val=-1) %}
{% for ep in episodes %}
  {% if ep.slug == slug %}{% set current_idx.val = loop.index0 %}{% endif %}
{% endfor %}
{% set prev_ep = episodes[current_idx.val + 1] if current_idx.val >= 0 and current_idx.val < episodes|length - 1 else None %}
{% set next_ep = episodes[current_idx.val - 1] if current_idx.val > 0 else None %}

<div class="player-container">

  <!-- BREADCRUMB & JUDUL -->
  {% set ep_ns = namespace(name='') %}
  {% for ep in episodes %}
    {% if ep.slug == slug %}{% set ep_ns.name = ep.name %}{% endif %}
  {% endfor %}

  <div class="breadcrumb">
    <a href="/">Beranda</a>
    <span class="breadcrumb-sep">‚Ä∫</span>
    {% set _aslug = anime_slug or (data.anime_id if data else '') %}
    {% if anime_data and anime_data.detail %}
    <a href="/anime/{{ _aslug }}" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:150px;display:inline-block">{{ anime_data.detail.title }}</a>
    <span class="breadcrumb-sep">‚Ä∫</span>
    {% elif _aslug %}
    <a href="/anime/{{ _aslug }}" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:150px;display:inline-block">{{ _aslug | replace("-", " ") | title }}</a>
    <span class="breadcrumb-sep">‚Ä∫</span>
    {% endif %}
    {% if data.title %}
      {% set parts = data.title.split() %}
      {% set ep_idx = namespace(val=-1) %}
      {% for i in range(parts|length) %}
        {% if parts[i].lower() == 'episode' %}{% set ep_idx.val = i %}{% endif %}
      {% endfor %}
      <span>{% if ep_idx.val >= 0 %}Episode {{ parts[ep_idx.val + 1] if ep_idx.val + 1 < parts|length else '' }}{% else %}Episode{% endif %}</span>
    {% else %}
      <span>{{ ep_ns.name if ep_ns.name else 'Episode' }}</span>
    {% endif %}
  </div>

  <!-- JUDUL -->
  <h1 class="player-title" style="margin-bottom:4px;font-size:clamp(15px,2.5vw,24px);line-height:1.3">
    {% if data.title %}
      {{ data.title }}
    {% elif anime_data and anime_data.detail %}
      {{ anime_data.detail.title }}{% if ep_ns.name %}<span style="color:var(--accent)"> ‚Äî {{ ep_ns.name }}</span>{% endif %}
    {% else %}
      Nonton Episode
    {% endif %}
  </h1>
  <p style="color:var(--text3);font-size:13px;margin-bottom:16px">Animeku.id ‚Äî Streaming Sub Indo</p>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- PAYWALL (tampil jika episode_number > 2 dan tidak punya akses) -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  {% if not has_access %}
  <div class="paywall-wrap" id="paywallSection">
    <div class="paywall-lock-icon">
      <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
      </svg>
    </div>
    <h2 class="paywall-title">Episode ini membutuhkan akses</h2>
    <p class="paywall-subtitle">
      Kamu sudah menonton <strong>2 episode gratis</strong>.<br>
      Pilih paket di bawah untuk melanjutkan nonton.
    </p>

    <div class="paywall-cards">
      <!-- Kartu Per-Anime -->
      <div class="paywall-card" onclick="openPaymentModal('per_anime')">
        <div class="paywall-card-label">HEMAT</div>
        <div class="paywall-card-icon">üé¨</div>
        <h3 class="paywall-card-title">Subscribe Anime Ini</h3>
        <div class="paywall-card-price">Rp 5.000</div>
        <p class="paywall-card-desc">Akses semua episode<br><strong>{{ anime_title }}</strong><br>selamanya</p>
        <button class="paywall-btn paywall-btn--secondary">Pilih Paket Ini</button>
      </div>

      <!-- Kartu Bulanan (featured) -->
      <div class="paywall-card paywall-card--featured" onclick="openPaymentModal('monthly')">
        <div class="paywall-card-label paywall-card-label--hot">‚ú® TERBAIK</div>
        <div class="paywall-card-icon">üëë</div>
        <h3 class="paywall-card-title">Basic Bulanan</h3>
        <div class="paywall-card-price">Rp 25.000<span class="paywall-per">/bulan</span></div>
        <p class="paywall-card-desc">Akses <strong>semua anime ongoing</strong><br>tanpa batas selama 30 hari</p>
        <button class="paywall-btn paywall-btn--primary">Pilih Paket Ini</button>
      </div>
    </div>

    <!-- Cek status pending -->
    <p class="paywall-check-status">Sudah transfer? <button onclick="checkMyPayments()" class="paywall-link-btn">Cek status pembayaran</button></p>
  </div>

  <!-- MODAL PEMBAYARAN -->
  <div id="paymentModal" class="pmodal-overlay" style="display:none">
    <div class="pmodal">
      <button class="pmodal-close" onclick="closePaymentModal()">‚úï</button>

      <div class="pmodal-header">
        <div class="pmodal-icon" id="modalIcon">üí≥</div>
        <h3 class="pmodal-title" id="modalTitle">Konfirmasi Pembayaran</h3>
        <p class="pmodal-subtitle" id="modalSubtitle"></p>
      </div>

      <!-- Step 1: Info transfer -->
      <div id="stepTransfer">
        <p style="color:var(--text3);font-size:10px;font-family:var(--font-mono);letter-spacing:2px;text-transform:uppercase;margin-bottom:10px;text-align:center">Pilih metode pembayaran</p>
        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px">

          <div class="ewallet-card" id="ew-dana" onclick="selectEwallet('dana')">
            <div class="ewallet-left">
              <div class="ewallet-logo" style="background:linear-gradient(135deg,#118ef4,#0067d0)">
                <span style="color:#fff;font-size:12px;font-weight:900;font-family:sans-serif">D</span>
              </div>
              <div>
                <div class="ewallet-name" style="color:#118ef4">DANA</div>
                <div class="ewallet-num">0823-2078-1747</div>
                <div class="ewallet-an">a.n. Dayynime</div>
              </div>
            </div>
            <button class="ewallet-copy-btn" onclick="event.stopPropagation();copyEwallet('0823-2078-1747','btn-dana')" id="btn-dana">üìã Salin</button>
          </div>

          <div class="ewallet-card" id="ew-ovo" onclick="selectEwallet('ovo')">
            <div class="ewallet-left">
              <div class="ewallet-logo" style="background:linear-gradient(135deg,#4c2a86,#7b2dff)">
                <span style="color:#fff;font-size:12px;font-weight:900;font-family:sans-serif">O</span>
              </div>
              <div>
                <div class="ewallet-name" style="color:#7b2dff">OVO</div>
                <div class="ewallet-num">0823-2078-1747</div>
                <div class="ewallet-an">a.n. Dayynime</div>
              </div>
            </div>
            <button class="ewallet-copy-btn" onclick="event.stopPropagation();copyEwallet('0823-2078-1747','btn-ovo')" id="btn-ovo">üìã Salin</button>
          </div>

          <div class="ewallet-card" id="ew-gopay" onclick="selectEwallet('gopay')">
            <div class="ewallet-left">
              <div class="ewallet-logo" style="background:linear-gradient(135deg,#00b14f,#007a36)">
                <span style="color:#fff;font-size:12px;font-weight:900;font-family:sans-serif">G</span>
              </div>
              <div>
                <div class="ewallet-name" style="color:#00b14f">GoPay</div>
                <div class="ewallet-num">0823-2078-1747</div>
                <div class="ewallet-an">a.n. Dayynime</div>
              </div>
            </div>
            <button class="ewallet-copy-btn" onclick="event.stopPropagation();copyEwallet('0823-2078-1747','btn-gopay')" id="btn-gopay">üìã Salin</button>
          </div>

        </div>

        <div class="pmodal-amount" id="modalAmount"></div>

        <p class="pmodal-note">
          ‚ö†Ô∏è Pastikan nominal transfer <strong>tepat</strong> sesuai harga paket.<br>
          Pembayaran diverifikasi admin dalam <strong>1√ó24 jam</strong>.
        </p>

        <button class="pmodal-btn-next" onclick="goToUpload()">
          Sudah Transfer ‚Üí Upload Bukti
        </button>
      </div>

      <!-- Step 2: Upload bukti -->
      <div id="stepUpload" style="display:none">
        <div class="pmodal-upload-area" id="uploadArea" onclick="document.getElementById('proofFile').click()">
          <div class="pmodal-upload-icon">üì∑</div>
          <p class="pmodal-upload-text">Klik untuk pilih foto bukti transfer</p>
          <p class="pmodal-upload-hint">JPG, PNG, maks 5MB</p>
          <img id="uploadPreview" src="" alt="" style="display:none;max-width:100%;max-height:200px;border-radius:8px;margin-top:12px">
        </div>
        <input type="file" id="proofFile" accept="image/*" style="display:none" onchange="previewFile(event)">

        <div id="uploadProgress" style="display:none;margin-top:12px">
          <div class="pmodal-progress-bar">
            <div class="pmodal-progress-fill" id="progressFill"></div>
          </div>
          <p class="pmodal-progress-text" id="progressText">Mengupload...</p>
        </div>

        <button class="pmodal-btn-next" id="submitBtn" onclick="submitPayment()" style="margin-top:16px" disabled>
          üöÄ Kirim Bukti Pembayaran
        </button>

        <button class="pmodal-btn-back" onclick="goBackToTransfer()">‚Üê Kembali</button>
      </div>

      <!-- Step 3: Sukses -->
      <div id="stepSuccess" style="display:none;text-align:center;padding:20px 0">
        <div style="font-size:56px;margin-bottom:16px">üéâ</div>
        <h3 style="color:var(--text);font-size:18px;margin-bottom:8px">Pembayaran Terkirim!</h3>
        <p style="color:var(--text2);font-size:14px;line-height:1.7">
          Bukti transfer kamu sudah kami terima.<br>
          Admin akan memverifikasi dalam <strong>1√ó24 jam</strong>.<br>
          Kamu akan mendapat akses otomatis setelah disetujui.
        </p>
        <button class="pmodal-btn-next" onclick="closePaymentModal()" style="margin-top:20px">Tutup</button>
      </div>

    </div>
  </div>

  <!-- MODAL STATUS PEMBAYARAN -->
  <div id="statusModal" class="pmodal-overlay" style="display:none">
    <div class="pmodal">
      <button class="pmodal-close" onclick="document.getElementById('statusModal').style.display='none'">‚úï</button>
      <h3 style="color:var(--text);font-size:16px;margin-bottom:16px">Status Pembayaran Kamu</h3>
      <div id="statusContent">
        <p style="color:var(--text3);font-size:13px">Memuat...</p>
      </div>
    </div>
  </div>

  <style>
  /* ‚îÄ‚îÄ PAYWALL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .paywall-wrap {
    background: var(--bg2, #0d1117);
    border: 1px solid rgba(230,57,70,0.15);
    border-radius: 20px;
    padding: 48px 24px 40px;
    text-align: center;
    margin-bottom: 24px;
  }
  .paywall-lock-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 88px; height: 88px;
    background: linear-gradient(135deg, rgba(230,57,70,0.12), rgba(230,57,70,0.04));
    border: 1px solid rgba(230,57,70,0.2);
    border-radius: 50%;
    color: #e63946;
    margin-bottom: 20px;
  }
  .paywall-title {
    font-family: var(--font-head, 'Bebas Neue', sans-serif);
    font-size: clamp(20px, 4vw, 28px);
    color: var(--text, #e8eaf0);
    letter-spacing: 2px;
    margin-bottom: 10px;
  }
  .paywall-subtitle {
    color: var(--text2, #8b92a5);
    font-size: 14px;
    line-height: 1.7;
    margin-bottom: 32px;
  }
  .paywall-subtitle strong { color: var(--text, #e8eaf0); }

  .paywall-cards {
    display: flex;
    gap: 16px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 24px;
  }
  .paywall-card {
    background: var(--card, #161b24);
    border: 1px solid var(--border, rgba(255,255,255,0.07));
    border-radius: 16px;
    padding: 28px 22px 22px;
    width: 200px;
    position: relative;
    cursor: pointer;
    transition: transform 0.25s, border-color 0.25s, box-shadow 0.25s;
    text-align: center;
  }
  .paywall-card:hover {
    transform: translateY(-4px);
    border-color: rgba(230,57,70,0.3);
    box-shadow: 0 12px 32px rgba(0,0,0,0.35);
  }
  .paywall-card--featured {
    border-color: rgba(230,57,70,0.4);
    background: linear-gradient(145deg, #1a0d10, #161b24);
    box-shadow: 0 0 0 1px rgba(230,57,70,0.15), 0 8px 32px rgba(230,57,70,0.12);
  }
  .paywall-card-label {
    position: absolute;
    top: -12px; left: 50%; transform: translateX(-50%);
    background: var(--card);
    border: 1px solid var(--border);
    color: var(--text3);
    font-size: 10px;
    font-family: var(--font-mono);
    font-weight: 700;
    letter-spacing: 1.5px;
    padding: 3px 10px;
    border-radius: 99px;
    white-space: nowrap;
  }
  .paywall-card-label--hot {
    background: linear-gradient(135deg, #e63946, #c0202a);
    border-color: transparent;
    color: #fff;
  }
  .paywall-card-icon { font-size: 32px; margin-bottom: 10px; }
  .paywall-card-title {
    color: var(--text);
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 6px;
  }
  .paywall-card-price {
    font-family: var(--font-head);
    font-size: 26px;
    color: #e63946;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }
  .paywall-per { font-size: 14px; color: var(--text3); font-family: var(--font-body); }
  .paywall-card-desc {
    color: var(--text3);
    font-size: 12px;
    line-height: 1.6;
    margin-bottom: 18px;
  }
  .paywall-card-desc strong { color: var(--text2); }
  .paywall-btn {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .paywall-btn--primary {
    background: linear-gradient(135deg, #e63946, #c0202a);
    color: #fff;
    box-shadow: 0 4px 16px rgba(230,57,70,0.35);
  }
  .paywall-btn--secondary {
    background: var(--bg2);
    color: var(--text);
    border: 1px solid var(--border);
  }
  .paywall-btn:hover { transform: translateY(-2px); }
  .paywall-check-status { color: var(--text3); font-size: 13px; margin-top: 8px; }
  .paywall-link-btn {
    background: none; border: none; color: var(--accent);
    font-size: 13px; cursor: pointer; text-decoration: underline;
    font-family: var(--font-body);
  }

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  .pmodal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(6px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    animation: fadeIn 0.25s ease;
  }
  @keyframes fadeIn { from { opacity:0 } to { opacity:1 } }
  .pmodal {
    background: var(--bg2, #0d1117);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 20px;
    padding: 32px 24px 28px;
    max-width: 420px;
    width: 100%;
    position: relative;
    animation: slideUp 0.3s cubic-bezier(.22,.68,0,1.2);
    max-height: 90vh;
    overflow-y: auto;
  }
  @keyframes slideUp { from { transform:translateY(24px);opacity:0 } to { transform:translateY(0);opacity:1 } }
  .pmodal-close {
    position: absolute; top: 14px; right: 16px;
    background: none; border: none;
    color: var(--text3); font-size: 18px; cursor: pointer;
    transition: color 0.2s;
  }
  .pmodal-close:hover { color: var(--text); }
  .pmodal-header { text-align: center; margin-bottom: 24px; }
  .pmodal-icon { font-size: 42px; margin-bottom: 10px; }
  .pmodal-title { color: var(--text); font-size: 18px; font-weight: 700; margin-bottom: 6px; }
  .pmodal-subtitle { color: var(--text2); font-size: 13px; }

  /* ewallet cards */
  .ewallet-card {
    display: flex; align-items: center; justify-content: space-between;
    background: var(--card); border: 1px solid var(--border);
    border-radius: 12px; padding: 13px 14px; cursor: pointer;
    transition: border-color 0.2s, transform 0.15s, background 0.2s;
  }
  .ewallet-card:hover { background: rgba(255,255,255,0.03); transform: translateX(2px); }
  .ewallet-card.ew-selected { border-color: rgba(230,57,70,0.4); background: rgba(230,57,70,0.04); }
  .ewallet-left { display: flex; align-items: center; gap: 12px; }
  .ewallet-logo {
    width: 38px; height: 38px; border-radius: 10px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
  }
  .ewallet-name { font-family: var(--font-head); font-size: 16px; letter-spacing: 1px; font-weight: 800; margin-bottom: 2px; }
  .ewallet-num  { font-family: var(--font-mono); font-size: 13px; font-weight: 700; color: var(--text); letter-spacing: 1px; }
  .ewallet-an   { font-size: 11px; color: var(--text3); margin-top: 1px; }
  .ewallet-copy-btn {
    background: rgba(255,255,255,0.06); border: 1px solid var(--border);
    border-radius: 8px; padding: 7px 12px; font-size: 12px; font-weight: 600;
    color: var(--text2); cursor: pointer; transition: all 0.2s; white-space: nowrap;
    font-family: var(--font-body);
  }
  .ewallet-copy-btn:hover { background: rgba(255,255,255,0.12); color: var(--text); }

  .pmodal-amount {
    text-align: center;
    background: rgba(230,57,70,0.08);
    border: 1px solid rgba(230,57,70,0.2);
    border-radius: 10px;
    padding: 14px;
    font-size: 28px;
    font-family: var(--font-head);
    color: #e63946;
    letter-spacing: 2px;
    margin-bottom: 14px;
  }
  .pmodal-note {
    color: var(--text3); font-size: 12px; line-height: 1.7;
    background: rgba(255,200,0,0.05);
    border: 1px solid rgba(255,200,0,0.15);
    border-radius: 8px; padding: 12px; margin-bottom: 20px;
  }
  .pmodal-note strong { color: var(--text2); }

  .pmodal-btn-next {
    width: 100%; padding: 13px;
    background: linear-gradient(135deg, #e63946, #c0202a);
    color: #fff; border: none; border-radius: 12px;
    font-size: 14px; font-weight: 700; cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 20px rgba(230,57,70,0.35);
  }
  .pmodal-btn-next:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(230,57,70,0.5); }
  .pmodal-btn-next:disabled { opacity: 0.4; cursor: not-allowed; }
  .pmodal-btn-back {
    width: 100%; margin-top: 10px; padding: 10px;
    background: none; border: 1px solid var(--border);
    color: var(--text2); border-radius: 10px; font-size: 13px; cursor: pointer;
    transition: border-color 0.2s;
  }
  .pmodal-btn-back:hover { border-color: var(--text3); }

  .pmodal-upload-area {
    border: 2px dashed var(--border);
    border-radius: 14px; padding: 32px 20px;
    text-align: center; cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
  }
  .pmodal-upload-area:hover { border-color: #e63946; background: rgba(230,57,70,0.04); }
  .pmodal-upload-icon { font-size: 36px; margin-bottom: 10px; }
  .pmodal-upload-text { color: var(--text2); font-size: 14px; font-weight: 600; margin-bottom: 4px; }
  .pmodal-upload-hint { color: var(--text3); font-size: 12px; }

  .pmodal-progress-bar { background: var(--card); border-radius: 99px; height: 4px; overflow: hidden; }
  .pmodal-progress-fill { height: 100%; background: linear-gradient(to right, #e63946, #ff6b6b); border-radius: 99px; width: 0%; transition: width 0.3s; }
  .pmodal-progress-text { color: var(--text3); font-size: 12px; margin-top: 8px; text-align: center; }

  /* Status badge */
  .status-badge {
    display: inline-block; padding: 3px 10px; border-radius: 99px;
    font-size: 11px; font-weight: 700; letter-spacing: 0.5px;
  }
  .status-badge--pending  { background: rgba(255,200,0,0.12); color: #ffd600; border: 1px solid rgba(255,200,0,0.25); }
  .status-badge--approved { background: rgba(76,175,80,0.12); color: #66bb6a; border: 1px solid rgba(76,175,80,0.25); }
  .status-badge--rejected { background: rgba(230,57,70,0.12); color: #e63946; border: 1px solid rgba(230,57,70,0.25); }
  </style>

  {% else %}
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- PLAYER (episode 1-2 GRATIS, atau sudah subscribe) -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <!-- Badge gratis untuk episode 1-2 -->
  {% if episode_number <= 2 %}
  <div style="display:inline-flex;align-items:center;gap:6px;background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.25);color:#66bb6a;font-size:12px;font-weight:700;padding:5px 12px;border-radius:99px;margin-bottom:12px;letter-spacing:0.5px">
    ‚úÖ GRATIS ‚Äî Episode Percobaan
  </div>
  {% else %}
  <div style="display:inline-flex;align-items:center;gap:6px;background:rgba(230,57,70,0.1);border:1px solid rgba(230,57,70,0.25);color:#e63946;font-size:12px;font-weight:700;padding:5px 12px;border-radius:99px;margin-bottom:12px;letter-spacing:0.5px">
    üëë SUBSCRIBER
  </div>
  {% endif %}

  <div class="player-frame" style="position:relative">

    <div id="playerPlaceholder" style="
      position:absolute;inset:0;
      background:#0a0a0a;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      gap:20px;z-index:5;border-radius:var(--radius,12px);
    ">
      <div class="ph-logo" id="phLogo">
        <span class="ph-a">A</span><span class="ph-n">N</span><span class="ph-i">I</span><span class="ph-m">M</span><span class="ph-e">E</span><span class="ph-k">K</span><span class="ph-u">U</span><span class="ph-dot">.</span><span class="ph-id">ID</span>
      </div>
      <p id="phSubtitle" style="color:rgba(255,255,255,0.45);font-size:13px;letter-spacing:2px;font-family:var(--font-mono,'monospace');text-transform:uppercase;opacity:0;transform:translateY(12px);transition:none">
        ‚Üì Pilih kualitas untuk memulai
      </p>
    </div>

    <style>
    .ph-logo {
      display:flex;align-items:baseline;gap:2px;
      font-family:var(--font-head,'sans-serif');
      font-size:clamp(32px,8vw,52px);
      font-weight:900;
      letter-spacing:2px;
    }
    .ph-logo span {
      display:inline-block;
      opacity:0;
      transform:translateY(30px) scale(0.7);
      transition: none;
    }
    .ph-logo span.ph-visible {
      opacity:1;
      transform:translateY(0) scale(1);
      transition: opacity 0.45s cubic-bezier(.22,.68,0,1.4), transform 0.45s cubic-bezier(.22,.68,0,1.4);
    }
    .ph-a  { color:#e53935; }
    .ph-n  { color:#fff; }
    .ph-i  { color:#fff; }
    .ph-m  { color:#fff; }
    .ph-e  { color:#fff; }
    .ph-k  { color:#fff; }
    .ph-u  { color:#fff; }
    .ph-dot{ color:#e53935; font-size:0.6em; }
    .ph-id { color:var(--text2); font-size:0.7em; }
    </style>

    <script>
    (function() {
      function animateLogo() {
        var spans = document.querySelectorAll('#phLogo span');
        var subtitle = document.getElementById('phSubtitle');
        spans.forEach(function(s) { s.classList.remove('ph-visible'); });
        if (subtitle) {
          subtitle.style.transition = 'none';
          subtitle.style.opacity = '0';
          subtitle.style.transform = 'translateY(12px)';
        }
        spans.forEach(function(s, i) {
          setTimeout(function() { s.classList.add('ph-visible'); }, 150 + i * 90);
        });
        var delay = 150 + spans.length * 90 + 100;
        setTimeout(function() {
          if (subtitle) {
            subtitle.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
            subtitle.style.opacity = '1';
            subtitle.style.transform = 'translateY(0)';
          }
        }, delay);
      }
      document.addEventListener('DOMContentLoaded', animateLogo);
      window.animateLogoPlaceholder = animateLogo;
    })();
    </script>

    {% if data.streams and data.streams | length > 0 %}
    <iframe id="playerIframe" src="about:blank"
      allowfullscreen allow="autoplay; fullscreen"
      sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-presentation"
      referrerpolicy="no-referrer"
      style="position:relative;z-index:1">
    </iframe>
    {% else %}
    <div class="player-placeholder">
      <p>Stream tidak tersedia untuk episode ini</p>
    </div>
    {% endif %}
  </div>

  <!-- SERVER TABS -->
  {% if data.streams and data.streams | length > 0 %}
  <div class="player-section">
    <p class="player-section-label">PILIH KUALITAS</p>
    <div class="server-tabs" id="qualityTabs">
      {% set seen_q = namespace(list=[]) %}
      {% for stream in data.streams %}
        {% set q = stream.name.split()[-1] if stream.name.split() else '' %}
        {% if q not in seen_q.list %}
          {% set _ = seen_q.list.append(q) %}
          <button class="server-btn {% if loop.first %}active{% endif %}"
            data-quality="{{ q }}"
            onclick="selectQuality(this, '{{ q }}')">
            {{ q }}
          </button>
        {% endif %}
      {% endfor %}
    </div>

    <p class="player-section-label" style="margin-top:14px">PILIH SERVER</p>
    {% set first_q = namespace(val='') %}
    {% for stream in data.streams %}
      {% if loop.first %}{% set first_q.val = stream.name.split()[-1] %}{% endif %}
    {% endfor %}

    {% set seen_q2 = namespace(list=[]) %}
    {% for stream in data.streams %}
      {% set q = stream.name.split()[-1] if stream.name.split() else '' %}
      {% if q not in seen_q2.list %}
        {% set _ = seen_q2.list.append(q) %}
        <div class="server-tabs server-group"
             id="group-{{ q }}"
             style="{{ '' if q == first_q.val else 'display:none' }}">
          {% for s in data.streams %}
            {% set sq = s.name.split()[-1] if s.name.split() else '' %}
            {% if sq == q %}
            <button class="server-btn"
              data-server-id="{{ s.serverId }}"
              data-url="{{ s.url if s.url else '' }}"
              onclick="switchServer(this)">
              {{ s.name.split()[:-1] | join(' ') if s.name.split()|length > 1 else s.name }}
            </button>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
    {% endfor %}

    <div id="serverLoading" style="display:none;color:var(--text3);font-size:13px;margin-top:8px">‚è≥ Memuat server...</div>
  </div>
  {% endif %}

  <div class="player-notice">
    <svg width="15" height="15" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
    <span>Jika video tidak muncul, coba ganti server atau nonaktifkan ad blocker.</span>
  </div>

  {% endif %} {# end has_access #}

  <!-- ACTION BAR -->
  <div class="player-action-bar">
    {% if anime_slug %}
    <a href="/anime/{{ anime_slug }}" class="btn btn-ghost btn-sm">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
      Detail Anime
    </a>
    {% else %}
    <a href="/" class="btn btn-ghost btn-sm">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg>
      Beranda
    </a>
    {% endif %}

    <div class="ep-prev-next">
      {% if prev_ep %}
      <a href="/episode/{{ prev_ep.slug }}?anime={{ anime_slug }}" class="btn btn-ghost btn-sm">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
        Prev
      </a>
      {% else %}
      <button class="btn btn-ghost btn-sm" disabled style="opacity:0.3">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 18l-6-6 6-6"/></svg>
        Prev
      </button>
      {% endif %}

      {% if next_ep %}
      <a href="/episode/{{ next_ep.slug }}?anime={{ anime_slug }}" class="btn btn-primary btn-sm">
        Next
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
      </a>
      {% else %}
      <button class="btn btn-ghost btn-sm" disabled style="opacity:0.3">
        Next
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M9 18l6-6-6-6"/></svg>
      </button>
      {% endif %}
    </div>
  </div>

  <!-- DAFTAR EPISODE -->
  {% if episodes | length > 0 %}
  <div class="player-ep-section">
    <button class="player-ep-toggle" id="epToggleBtn" onclick="toggleEpList()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
      Daftar Episode ({{ episodes | length }})
    </button>
    <div class="hidden" id="epListGrid">
      <div class="episodes-grid" style="margin-top:12px">
        {% set total_eps = episodes | length %}
        {% for ep in episodes %}
        {% set ep_num = total_eps - loop.index0 %}
        <a href="/episode/{{ ep.slug }}?anime={{ anime_slug }}"
           class="ep-btn {% if ep.slug == slug %}active{% endif %}"
           style="position:relative">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3l14 9-14 9V3z"/></svg>
          {{ ep.name }}
          {% if ep_num > 2 %}
          <span style="position:absolute;top:2px;right:2px;font-size:8px;color:#e63946" title="Butuh subscribe">üîí</span>
          {% endif %}
        </a>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

</div>

<!-- ‚îÄ‚îÄ JAVASCRIPT PAYWALL & PLAYER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<script>
// ‚îÄ‚îÄ Konstanta ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ANIME_SLUG_PAGE  = '{{ anime_slug }}';
const ANIME_TITLE_PAGE = {{ anime_title | tojson }};
const SUPABASE_URL_CLI = 'https://mafnnqttvkdgqqxczqyt.supabase.co';
const SUPABASE_ANON    = '{{ config.get("SUPABASE_ANON_KEY", "") }}';

// ‚îÄ‚îÄ State modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentPlan   = null;
let uploadedProofUrl = null;

function openPaymentModal(planId) {
  // Cek login dulu
  const user = getUser();
  if (!user) {
    alert('Kamu harus login dulu untuk subscribe!');
    window.location.href = '/auth/login';
    return;
  }

  currentPlan      = planId;
  uploadedProofUrl = null;

  const modal       = document.getElementById('paymentModal');
  const modalIcon   = document.getElementById('modalIcon');
  const modalTitle  = document.getElementById('modalTitle');
  const modalSub    = document.getElementById('modalSubtitle');
  const modalAmount = document.getElementById('modalAmount');

  if (planId === 'monthly') {
    modalIcon.textContent  = 'üëë';
    modalTitle.textContent = 'Basic Bulanan';
    modalSub.textContent   = 'Akses semua anime ongoing selama 30 hari';
    modalAmount.textContent = 'Rp 25.000';
  } else {
    modalIcon.textContent  = 'üé¨';
    modalTitle.textContent = 'Subscribe Anime Ini';
    modalSub.textContent   = ANIME_TITLE_PAGE;
    modalAmount.textContent = 'Rp 5.000';
  }

  // Reset ke step 1
  document.getElementById('stepTransfer').style.display = 'block';
  document.getElementById('stepUpload').style.display   = 'none';
  document.getElementById('stepSuccess').style.display  = 'none';
  document.getElementById('uploadPreview').style.display = 'none';
  document.getElementById('uploadProgress').style.display = 'none';
  document.getElementById('submitBtn').disabled = true;

  modal.style.display = 'flex';
}

function closePaymentModal() {
  document.getElementById('paymentModal').style.display = 'none';
}

function goToUpload() {
  document.getElementById('stepTransfer').style.display = 'none';
  document.getElementById('stepUpload').style.display   = 'block';
}

function goBackToTransfer() {
  document.getElementById('stepUpload').style.display   = 'none';
  document.getElementById('stepTransfer').style.display = 'block';
}

function selectEwallet(name) {
  document.querySelectorAll('.ewallet-card').forEach(c => c.classList.remove('ew-selected'));
  const card = document.getElementById('ew-' + name);
  if (card) card.classList.add('ew-selected');
}

function copyEwallet(number, btnId) {
  const cleanNum = number.replace(/-/g, '');
  navigator.clipboard.writeText(cleanNum).then(() => {
    const btn = document.getElementById(btnId);
    if (!btn) return;
    const orig = btn.textContent;
    btn.textContent = '‚úÖ Tersalin!';
    btn.style.color = '#66bb6a';
    setTimeout(() => { btn.textContent = orig; btn.style.color = ''; }, 2000);
  }).catch(() => {
    // Fallback untuk browser yang tidak support clipboard API
    const el = document.createElement('textarea');
    el.value = cleanNum;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    const btn = document.getElementById(btnId);
    if (btn) { const o = btn.textContent; btn.textContent = '‚úÖ Tersalin!'; setTimeout(() => btn.textContent = o, 2000); }
  });
}

// Preview foto sebelum upload
function previewFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 5 * 1024 * 1024) {
    alert('File terlalu besar. Maksimal 5MB.');
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    const preview = document.getElementById('uploadPreview');
    preview.src = e.target.result;
    preview.style.display = 'block';
  };
  reader.readAsDataURL(file);

  // Langsung upload ke Supabase Storage
  uploadProofFile(file);
}

async function uploadProofFile(file) {
  const progress     = document.getElementById('uploadProgress');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const submitBtn    = document.getElementById('submitBtn');

  progress.style.display = 'block';
  progressFill.style.width = '20%';
  progressText.textContent = 'Mengupload bukti transfer...';

  try {
    const formData = new FormData();
    formData.append('file', file);

    progressFill.style.width = '50%';
    progressText.textContent = 'Menyimpan file...';

    // Kirim token dari localStorage supaya backend bisa verifikasi user
    const token = localStorage.getItem('sb_access_token') || '';
    const upResp = await fetch('/api/payment/upload-proof', {
      method: 'POST',
      headers: token ? { 'Authorization': 'Bearer ' + token } : {},
      body: formData,
    });
    const upData = await upResp.json();
    if (!upResp.ok || !upData.url) throw new Error(upData.error || 'Upload gagal');

    uploadedProofUrl = upData.url;
    progressFill.style.width = '100%';
    progressText.textContent = '‚úÖ Upload berhasil!';
    submitBtn.disabled = false;

  } catch (err) {
    progressText.textContent = '‚ùå Upload gagal. Coba lagi.';
    progressFill.style.width = '0%';
    console.error(err);
  }
}

async function submitPayment() {
  if (!uploadedProofUrl) {
    alert('Upload bukti transfer dulu ya!');
    return;
  }

  const submitBtn = document.getElementById('submitBtn');
  submitBtn.disabled = true;
  submitBtn.textContent = '‚è≥ Mengirim...';

  try {
    const token = localStorage.getItem('sb_access_token') || '';
    const resp = await fetch('/api/payment/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', ...(token ? {'Authorization': 'Bearer ' + token} : {}) },
      body: JSON.stringify({
        plan_id:       currentPlan,
        anime_slug:    currentPlan === 'per_anime' ? ANIME_SLUG_PAGE : null,
        anime_title:   currentPlan === 'per_anime' ? ANIME_TITLE_PAGE : null,
        payment_proof: uploadedProofUrl,
      }),
    });
    const data = await resp.json();

    if (resp.ok && data.ok) {
      document.getElementById('stepUpload').style.display  = 'none';
      document.getElementById('stepSuccess').style.display = 'block';
    } else {
      alert(data.error || 'Gagal mengirim pembayaran. Coba lagi.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'üöÄ Kirim Bukti Pembayaran';
    }
  } catch (err) {
    alert('Terjadi error. Coba lagi.');
    submitBtn.disabled = false;
    submitBtn.textContent = 'üöÄ Kirim Bukti Pembayaran';
  }
}

async function checkMyPayments() {
  const statusModal   = document.getElementById('statusModal');
  const statusContent = document.getElementById('statusContent');
  statusModal.style.display = 'flex';
  statusContent.innerHTML   = '<p style="color:var(--text3);font-size:13px">Memuat status...</p>';

  try {
    const token = localStorage.getItem('sb_access_token') || '';
    const resp = await fetch('/api/my/subscriptions', {
      headers: token ? {'Authorization': 'Bearer ' + token} : {}
    });
    const data = await resp.json();

    if (!resp.ok) {
      statusContent.innerHTML = '<p style="color:#e63946">Login dulu ya!</p>';
      return;
    }

    const pending = data.pending_payments || [];
    const subs    = data.subscriptions    || [];

    let html = '';

    if (subs.length) {
      html += '<p style="color:var(--text2);font-size:12px;font-family:var(--font-mono);letter-spacing:1px;margin-bottom:8px">LANGGANAN AKTIF</p>';
      html += subs.map(s => `
        <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div>
              <div style="font-size:13px;font-weight:700;color:var(--text)">${s.plan_id === 'monthly' ? 'üëë Basic Bulanan' : 'üé¨ Per Anime'}</div>
              ${s.anime_slug ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">${s.anime_slug}</div>` : ''}
              ${s.expired_at ? `<div style="font-size:11px;color:var(--text3);margin-top:2px">Berakhir: ${new Date(s.expired_at).toLocaleDateString('id-ID')}</div>` : '<div style="font-size:11px;color:#66bb6a;margin-top:2px">Selamanya</div>'}
            </div>
            <span class="status-badge status-badge--approved">AKTIF</span>
          </div>
        </div>`).join('');
    }

    if (pending.length) {
      html += '<p style="color:var(--text2);font-size:12px;font-family:var(--font-mono);letter-spacing:1px;margin-bottom:8px;margin-top:16px">MENUNGGU VERIFIKASI</p>';
      html += pending.map(p => `
        <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px 14px;margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
            <div>
              <div style="font-size:13px;font-weight:700;color:var(--text)">${p.plan_id === 'monthly' ? 'üëë Basic Bulanan' : 'üé¨ ' + (p.anime_title || p.anime_slug)}</div>
              <div style="font-size:11px;color:var(--text3);margin-top:2px">Rp ${(p.amount||0).toLocaleString('id-ID')} ‚Ä¢ ${new Date(p.created_at).toLocaleDateString('id-ID')}</div>
            </div>
            <span class="status-badge status-badge--pending">PENDING</span>
          </div>
        </div>`).join('');
    }

    if (!subs.length && !pending.length) {
      html = '<p style="color:var(--text3);font-size:13px">Belum ada langganan atau pembayaran aktif.</p>';
    }

    statusContent.innerHTML = html;
  } catch (err) {
    statusContent.innerHTML = '<p style="color:#e63946">Gagal memuat status. Coba lagi.</p>';
  }
}

// ‚îÄ‚îÄ Player functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getUser() {
  try { return JSON.parse(localStorage.getItem('sb_user')); } catch { return null; }
}

function selectQuality(btn, quality) {
  document.querySelectorAll('#qualityTabs .server-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.querySelectorAll('.server-group').forEach(g => g.style.display = 'none');
  const group = document.getElementById('group-' + quality);
  if (group) {
    group.style.display = 'flex';
    const firstSrv = group.querySelector('.server-btn');
    if (firstSrv) switchServer(firstSrv);
  }
}

async function switchServer(btn) {
  document.querySelectorAll('.server-group .server-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const iframe = document.getElementById('playerIframe');
  if (!iframe) return;

  const directUrl = btn.dataset.url;
  if (directUrl) {
    hidePlaceholder();
    iframe.src = directUrl;
    return;
  }

  const serverId = btn.dataset.serverId;
  if (!serverId) return;
  const loading = document.getElementById('serverLoading');
  if (loading) loading.style.display = 'block';
  try {
    const res  = await fetch(`/api/server/${serverId}`);
    const json = await res.json();
    if (json.url) {
      hidePlaceholder();
      iframe.src = json.url;
      btn.dataset.url = json.url;
    }
  } catch(e) {
    console.error('Failed to fetch server URL', e);
  } finally {
    if (loading) loading.style.display = 'none';
  }
}

function hidePlaceholder() {
  const ph = document.getElementById('playerPlaceholder');
  if (ph) {
    ph.style.transition = 'opacity 0.4s';
    ph.style.opacity = '0';
    setTimeout(() => ph.style.display = 'none', 400);
  }
}

function toggleEpList() {
  document.getElementById('epListGrid').classList.toggle('hidden');
  document.getElementById('epToggleBtn').classList.toggle('open');
}

document.addEventListener('DOMContentLoaded', function() {
  const firstBtn = document.querySelector('.server-btn.active');
  if (firstBtn) switchServer(firstBtn);

  if (typeof saveEpisodeProgress === 'function') {
    saveEpisodeProgress(
      '{{ anime_slug }}',
      {{ (anime_data.detail.title if anime_data and anime_data.detail else data.title) | tojson }},
      {{ (anime_data.detail.poster if anime_data and anime_data.detail else '') | tojson }},
      '{{ slug }}',
      {{ data.title | tojson }}
    );
  }
});

// Tutup modal kalau klik overlay
document.getElementById('paymentModal')?.addEventListener('click', function(e) {
  if (e.target === this) closePaymentModal();
});
document.getElementById('statusModal')?.addEventListener('click', function(e) {
  if (e.target === this) this.style.display = 'none';
});
</script>

<!-- KOMENTAR -->
<div class="container" style="max-width:860px;margin:0 auto;padding:0 16px 60px">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
    <div style="width:3px;height:20px;background:var(--accent);border-radius:2px"></div>
    <h3 style="font-size:15px;font-weight:700;color:var(--text);font-family:var(--font-head);letter-spacing:1px;margin:0">KOMENTAR</h3>
  </div>
  <div id="commentFormWrap" style="margin-bottom:24px"></div>
  <div id="commentList" style="display:flex;flex-direction:column;gap:10px">
    <p style="color:var(--text3);font-size:13px;font-family:var(--font-mono)">Memuat komentar...</p>
  </div>
</div>

<style>
.comment-card { display:flex;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;transition:border-color 0.2s; }
.comment-card:hover { border-color:rgba(230,57,70,0.2); }
.comment-avatar { width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0;border:2px solid var(--border); }
.comment-avatar-placeholder { width:36px;height:36px;border-radius:50%;background:var(--accent);color:#fff;font-weight:700;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-family:var(--font-head); }
.comment-name { font-weight:600;font-size:13px;color:var(--text); }
.comment-time { font-size:11px;color:var(--text3);font-family:var(--font-mono); }
.comment-body { font-size:14px;color:var(--text2);margin:6px 0 0;line-height:1.6;word-break:break-word; }
.comment-delete { background:none;border:none;color:var(--text3);font-size:11px;cursor:pointer;padding:0;margin-top:8px;font-family:var(--font-mono);transition:color 0.2s; }
.comment-delete:hover { color:var(--accent); }
.comment-input { width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;color:var(--text);font-size:14px;resize:vertical;font-family:var(--font-body);transition:border-color 0.2s;box-sizing:border-box; }
.comment-input:focus { outline:none;border-color:rgba(230,57,70,0.45); }
.comment-input::placeholder { color:var(--text3); }
</style>

<script>
const SUPABASE_URL_CMT  = 'https://mafnnqttvkdgqqxczqyt.supabase.co';
const SUPABASE_ANON_CMT = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hZm5ucXR0dmtkZ3FxeGN6cXl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NzQyMDEsImV4cCI6MjA4NzQ1MDIwMX0.YRh1oWVKnn4tyQNRbcPhlSyvr7V_1LseWN7VjcImb-Y';
const ANIME_SLUG_COMMENT = '{{ anime_slug or slug }}';

function getCmtUser() { try { return JSON.parse(localStorage.getItem('sb_user')); } catch { return null; } }
function getCmtToken() { return localStorage.getItem('sb_access_token'); }
let currentUser = getCmtUser();

async function initComments() { renderCommentForm(currentUser); loadComments(); }

function renderCommentForm(user) {
  const wrap = document.getElementById('commentFormWrap');
  if (user) {
    const initial = (user.name || 'U')[0].toUpperCase();
    const avatarHtml = user.avatar
      ? `<img src="${user.avatar}" alt="" class="comment-avatar" style="margin-top:2px">`
      : `<div class="comment-avatar-placeholder" style="margin-top:2px">${initial}</div>`;
    wrap.innerHTML = `
      <div style="display:flex;gap:12px;align-items:flex-start;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px">
        ${avatarHtml}
        <div style="flex:1">
          <textarea id="commentInput" placeholder="Tulis komentar..." rows="2" class="comment-input"></textarea>
          <button onclick="submitComment()" class="btn btn-primary btn-sm" style="margin-top:10px">Kirim</button>
        </div>
      </div>`;
  } else {
    wrap.innerHTML = `<a href="/auth/login" class="btn btn-primary btn-sm">üîë Login untuk berkomentar</a>`;
  }
}

async function loadComments() {
  const r = await fetch(`${SUPABASE_URL_CMT}/rest/v1/anime_comments?anime_slug=eq.${ANIME_SLUG_COMMENT}&order=created_at.desc&select=*`, {
    headers: { 'apikey': SUPABASE_ANON_CMT, 'Authorization': `Bearer ${SUPABASE_ANON_CMT}` }
  });
  const comments = await r.json();
  const list = document.getElementById('commentList');
  if (!Array.isArray(comments) || !comments.length) {
    list.innerHTML = '<p style="color:var(--text3);font-size:13px;font-family:var(--font-mono)">Belum ada komentar. Jadilah yang pertama!</p>';
    return;
  }
  list.innerHTML = comments.map(c => {
    const initial = (c.user_name || 'U')[0].toUpperCase();
    const avatarHtml = c.user_avatar ? `<img src="${c.user_avatar}" alt="" class="comment-avatar">` : `<div class="comment-avatar-placeholder">${initial}</div>`;
    const deleteBtn = currentUser && currentUser.id === c.user_id ? `<button onclick="deleteCmt('${c.id}')" class="comment-delete">‚Äî Hapus</button>` : '';
    return `<div class="comment-card">${avatarHtml}<div style="flex:1;min-width:0"><div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><span class="comment-name">${escHtml(c.user_name||'User')}</span><span class="comment-time">${timeAgo(c.created_at)}</span></div><p class="comment-body">${escHtml(c.content)}</p>${deleteBtn}</div></div>`;
  }).join('');
}

async function submitComment() {
  const input = document.getElementById('commentInput');
  const content = (input.value||'').trim();
  if (!content) return;
  const token = getCmtToken();
  const user = getCmtUser();
  if (!token || !user) { alert('Login dulu ya!'); return; }
  const r = await fetch(`${SUPABASE_URL_CMT}/rest/v1/anime_comments`, {
    method: 'POST',
    headers: { 'apikey': SUPABASE_ANON_CMT, 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
    body: JSON.stringify({ anime_slug: ANIME_SLUG_COMMENT, user_id: user.id, user_name: user.name, user_avatar: user.avatar, content })
  });
  if (r.ok) { input.value = ''; loadComments(); }
  else { const err = await r.json().catch(() => ({})); alert('Gagal kirim komentar: ' + (err.message || r.status)); }
}

async function deleteCmt(id) {
  if (!confirm('Hapus komentar ini?')) return;
  const token = getCmtToken();
  await fetch(`${SUPABASE_URL_CMT}/rest/v1/anime_comments?id=eq.${id}`, { method:'DELETE', headers:{'apikey':SUPABASE_ANON_CMT,'Authorization':`Bearer ${token}`} });
  loadComments();
}

function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function timeAgo(iso) {
  const diff = (Date.now() - new Date(iso)) / 1000;
  if (diff < 60) return 'baru saja';
  if (diff < 3600) return Math.floor(diff/60) + ' menit lalu';
  if (diff < 86400) return Math.floor(diff/3600) + ' jam lalu';
  return Math.floor(diff/86400) + ' hari lalu';
}

initComments();
</script>

{% else %}
<div class="container empty-state" style="padding-top:80px">
  <h3>Episode tidak ditemukan</h3>
  <p><a href="/" style="color:var(--accent)">Kembali ke beranda</a></p>
</div>
{% endif %}
{% endblock %}
